<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸ªäººä¿¡æ¯ - æ½˜å¤šæ‹‰å·¥ä½œæ—¥å¿—ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/theme.css">
    <style>
        body { align-items: flex-start; }
        .layout { width: 100%; max-width: 1320px; margin: 32px auto; padding: 0 40px; }
        .topbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .brand { display: flex; align-items: center; gap: 12px; }
        .brand .logo { width: 48px; height: 48px; margin: 0; }
        .brand strong { font-size: 20px; font-family: 'ZCOOL KuaiLe', 'Noto Sans SC', sans-serif; }
        .avatar { width: 72px; height: 72px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, var(--color-peach), var(--color-primary-2)); border: 2px solid #fff; box-shadow: 0 3px 10px rgba(255,138,0,0.25); }
        .avatar:hover .avatar-overlay { opacity: 1 !important; }
        .avatar.has-image { background-size: cover; background-position: center; }
        .panel { background: #fff; border-radius: 14px; padding: 18px; }
        .nav-links { display:flex; gap:10px; }
        .nav-links a { padding:8px 12px; border-radius:10px; background:#fff7ef; border:1px solid #ffd3a1; color:#a55b00; text-decoration:none; }
        .nav-links a:hover { background:#ffe9d2; }
        .panel h3 { margin-bottom: 12px; color: #a55b00; font-family: 'ZCOOL KuaiLe', 'Noto Sans SC', sans-serif; font-size: 22px; text-align:center; }
        .profile-hero { display: flex; align-items: center; justify-content: center; gap: 16px; margin-bottom: 16px; text-align: center; }
        .profile-title { font-size: 22px; line-height: 1.2; }
        .profile-subtitle { color: #7a5a33; font-size: 13px; margin-top: 2px; }
        .chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 6px; justify-content: center; }
        .chip { padding: 4px 10px; border-radius: 999px; background: #fff7ef; border: 1px solid #ffd3a1; color: #a55b00; font-size: 12px; }
        .chip:empty { display: none; }
        .profile-form { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; max-width: 900px; margin: 0 auto; }
        .profile-form .full { grid-column: span 2; }
        .form-item { display: flex; flex-direction: column; gap: 6px; }
        .form-item label { color: #7a5a33; font-size: 15px; }
        .form-item input, .form-item select, .form-item textarea { padding: 12px 14px; border: 1px solid #ffd3a1; border-radius: 12px; background: #fff; }
        .form-item textarea { min-height: 110px; resize: vertical; }
        .row-center { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; margin-top: 10px; }
        .btn-sm { padding: 10px 14px; border-radius: 10px; background: linear-gradient(to right, var(--color-primary), var(--color-primary-2)); color: #fff; border: none; cursor: pointer; }
        .btn-secondary { padding: 10px 14px; border-radius: 10px; border: 1px solid #ffd3a1; background: #fff; color: #a55b00; cursor: pointer; }
        .btn-warning { padding: 10px 14px; border-radius: 10px; background: linear-gradient(to right, #ff9a3c, #ffb06b); color: #fff; border: none; cursor: pointer; }
        .btn-danger { padding: 10px 14px; border-radius: 10px; background: linear-gradient(to right, #ff6a00, #ff8a00); color: #fff; border: none; cursor: pointer; }
    </style>
</head>
<body>
    <div class="layout">
        <div class="topbar">
            <div class="brand">
                <div class="logo">P</div>
                <strong>ä¸ªäººä¿¡æ¯</strong>
            </div>
            <div style="display:flex; align-items:center; gap:16px;">
                <nav class="nav-links">
                    <a href="publish.html">å‘å¸ƒä»»åŠ¡</a>
                    <a href="dashboard.html">å·¥ä½œæ—¥å¿—</a>
                    <a href="users.html">ç”¨æˆ·ç®¡ç†</a>
                    <a href="tasks.html">ä»»åŠ¡å±•ç¤º</a>
                    <a href="calendar.html">æ—¥ç¨‹è¡¨</a>
                </nav>
                <div class="profile" onclick="location.href='profile.html'" style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                <span id="currentUserName">ç”¨æˆ·</span>
                <div class="avatar" style="width:40px;height:40px;"></div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="profile-hero">
                <div class="profile-avatar-container">
                    <div class="avatar profile-avatar" id="profileAvatar" style="position: relative; cursor: pointer;" title="ç‚¹å‡»æ›´æ¢å¤´åƒ">
                        <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                        <div class="avatar-overlay" style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); color: white; text-align: center; padding: 4px; font-size: 11px; border-radius: 0 0 50% 50%; opacity: 0; transition: opacity 0.3s;">
                            <i class="fas fa-camera"></i> æ›´æ¢
                        </div>
                    </div>
                    <div class="profile-info">
                        <div class="profile-title"><strong id="p_username">ç”¨æˆ·å</strong></div>
                        <div id="p_employeeId" class="profile-subtitle">å‘˜å·¥ç¼–å·</div>
                        <div id="p_email" class="profile-subtitle">é‚®ç®±</div>
                        <div id="p_company" class="profile-subtitle">å·¥ä½œå•ä½</div>
                    </div>
                </div>
                <div class="chips">
                    <span class="chip" id="chip_gender"></span>
                    <span class="chip" id="chip_age"></span>
                </div>
            </div>
            <form id="profileForm" class="profile-form">
                <div class="form-item">
                    <label>å§“å</label>
                    <input id="pf_name" placeholder="è¯·è¾“å…¥å§“å">
                </div>
                <div class="form-item">
                    <label>é‚®ç®±</label>
                    <input id="pf_email" type="email" placeholder="è¯·è¾“å…¥é‚®ç®±">
                </div>
                <div class="form-item">
                    <label>æ‰‹æœºå·</label>
                    <input id="pf_phone" type="tel" placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
                </div>
                <div class="form-item">
                    <label>æ€§åˆ«</label>
                    <select id="pf_gender">
                        <option value="">ä¿å¯†</option>
                        <option value="ç”·">ç”·</option>
                        <option value="å¥³">å¥³</option>
                    </select>
                </div>
                <div class="form-item">
                    <label>å‡ºç”Ÿå¹´æœˆ</label>
                    <input id="pf_birth" type="date">
                </div>
                <div class="form-item">
                    <label>å¹´é¾„</label>
                    <input id="pf_age" type="number" min="0" max="120" placeholder="å¹´é¾„">
                </div>
                <div class="form-item">
                    <label>å·¥ä½œå•ä½</label>
                    <input id="pf_company" placeholder="è¯·è¾“å…¥å·¥ä½œå•ä½">
                </div>
                <div class="form-item full">
                    <label>ä¸ªäººç®€ä»‹</label>
                    <textarea id="pf_bio" placeholder="ä»‹ç»ä¸€ä¸‹è‡ªå·±å§"></textarea>
                </div>
                <div class="row-center full">
                    <button type="button" class="btn-warning" id="deactivateBtn">æ³¨é”€è´¦å·</button>
                </div>
                <div class="row-center full">
                    <button type="button" class="btn-danger" id="logoutBtn">é€€å‡ºç™»å½•</button>
                </div>
                <div class="row-center full">
                    <button type="button" class="btn-sm" id="saveProfileBtn">ä¿å­˜</button>
                    <button type="button" class="btn-secondary" id="resetProfileBtn">é‡ç½®</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script src="js/api.js"></script>
    <script src="js/profile.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async function(){ 
            // ä»çœŸå®APIåŠ è½½ä¸ªäººèµ„æ–™
            try {
                if(window.API && typeof window.API.getProfile === 'function'){
                    console.log('ğŸ”„ ä»APIåŠ è½½ä¸ªäººèµ„æ–™...');
                    var profileData = await window.API.getProfile();
                    console.log('âœ… APIè¿”å›çš„ä¸ªäººèµ„æ–™:', profileData);
                    
                    if(profileData && (profileData.user_id || profileData.name)) {
                        // å¡«å……è¡¨å•ï¼ˆä½¿ç”¨æ­£ç¡®çš„IDï¼‰
                        console.log('å¼€å§‹å¡«å……è¡¨å•ï¼Œæ•°æ®:', profileData);
                        
                        document.getElementById('pf_name').value = profileData.name || '';
                        document.getElementById('pf_email').value = profileData.email || '';
                        
                        var phoneField = document.getElementById('pf_phone');
                        if(phoneField) phoneField.value = profileData.phone || '';
                        
                        // æ€§åˆ«å­—æ®µ - å¤„ç†å¯èƒ½çš„å€¼
                        var genderField = document.getElementById('pf_gender');
                        if(genderField && profileData.gender) {
                            genderField.value = profileData.gender;
                        }
                        
                        // æ—¥æœŸå­—æ®µ - è½¬æ¢æ ¼å¼ "2025-10-25T06:36:31" -> "2025-10-25"
                        var birthField = document.getElementById('pf_birth');
                        if(birthField) {
                            var birthDate = profileData.birthday || profileData.birth_date;
                            if(birthDate) {
                                // æå–æ—¥æœŸéƒ¨åˆ†ï¼ˆYYYY-MM-DDï¼‰
                                var dateOnly = birthDate.split('T')[0];
                                birthField.value = dateOnly;
                                console.log('ç”Ÿæ—¥å­—æ®µè®¾ç½®ä¸º:', dateOnly);
                            }
                        }
                        
                        // å¹´é¾„å­—æ®µå·²åœ¨ä¸Šé¢é€šè¿‡å‡ºç”Ÿæ—¥æœŸè‡ªåŠ¨è®¡ç®—å¹¶å¡«å……
                        
                        // å·¥ä½œå•ä½å­—æ®µ
                        var companyField = document.getElementById('pf_company');
                        if(companyField) {
                            companyField.value = profileData.company || profileData.team || '';
                        }
                        
                        // ä¸ªäººç®€ä»‹å­—æ®µ
                        var bioField = document.getElementById('pf_bio');
                        if(bioField) {
                            bioField.value = profileData.bio || '';
                        }
                        
                        // ğŸ”§ å…³é”®ä¿®å¤ï¼šæ›´æ–°å¤´åƒä¸‹æ–¹çš„æ˜¾ç¤ºå…ƒç´ 
                        // å¤´åƒä¸‹æ–¹æ˜¾ç¤ºusernameï¼ˆä¸æ˜¯nameï¼‰
                        var pUsernameElem = document.getElementById('p_username');
                        if(pUsernameElem) pUsernameElem.textContent = profileData.username || 'ç”¨æˆ·å';
                        
                        var pEmailElem = document.getElementById('p_email');
                        if(pEmailElem) pEmailElem.textContent = profileData.email || '';
                        
                        var pEmployeeIdElem = document.getElementById('p_employeeId');
                        if(pEmployeeIdElem) pEmployeeIdElem.textContent = profileData.employeeId || profileData.employee_id || '';
                        
                        var pCompanyElem = document.getElementById('p_company');
                        if(pCompanyElem) pCompanyElem.textContent = profileData.company || profileData.team || 'æ— ';
                        
                        // ğŸ”§ è‡ªåŠ¨è®¡ç®—å¹´é¾„å¹¶æ›´æ–°chipsæ˜¾ç¤º
                        var chipGender = document.getElementById('chip_gender');
                        if(chipGender) chipGender.textContent = profileData.gender || '';
                        
                        // æ ¹æ®å‡ºç”Ÿæ—¥æœŸè‡ªåŠ¨è®¡ç®—å¹´é¾„
                        var calculatedAge = null;
                        var birthDate = profileData.birthday || profileData.birth_date;
                        if(birthDate) {
                            var birth = new Date(birthDate);
                            var today = new Date();
                            calculatedAge = today.getFullYear() - birth.getFullYear();
                            var monthDiff = today.getMonth() - birth.getMonth();
                            if(monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                                calculatedAge--;
                            }
                            console.log('è®¡ç®—å¹´é¾„: å‡ºç”Ÿæ—¥æœŸ=' + birthDate + ', å¹´é¾„=' + calculatedAge);
                        }
                        
                        var chipAge = document.getElementById('chip_age');
                        if(chipAge && calculatedAge !== null && calculatedAge >= 0) {
                            chipAge.textContent = calculatedAge + 'å²';
                        }
                        
                        // è‡ªåŠ¨å¡«å……å¹´é¾„åˆ°è¡¨å•
                        var ageField = document.getElementById('pf_age');
                        if(ageField && calculatedAge !== null && calculatedAge >= 0) {
                            ageField.value = calculatedAge;
                        }
                        
                        // ğŸ”§ æ›´æ–°é¡¶éƒ¨å¯¼èˆªæ çš„ç”¨æˆ·åæ˜¾ç¤º
                        var currentUserNameElem = document.getElementById('currentUserName');
                        if(currentUserNameElem) currentUserNameElem.textContent = profileData.name || 'ç”¨æˆ·';
                        
                        // ğŸ”§ åŒæ­¥æ›´æ–°currentUseråˆ°localStorageï¼ˆç¡®ä¿å…¶ä»–é¡µé¢ä¹Ÿèƒ½è·å–åˆ°æœ€æ–°ç”¨æˆ·ä¿¡æ¯ï¼‰
                        try {
                            var currentUser = {
                                name: profileData.name || '',
                                email: profileData.email || '',
                                employeeId: profileData.employeeId || profileData.employee_id || '',
                                user_id: profileData.user_id || profileData.id || '',
                                id: profileData.user_id || profileData.id || ''
                            };
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            console.log('âœ… currentUserå·²åŒæ­¥æ›´æ–°:', currentUser);
                        } catch(e) {
                            console.warn('âš ï¸ currentUseræ›´æ–°å¤±è´¥:', e);
                        }
                        
                        // ä¿å­˜åˆ°localStorageä½œä¸ºç¼“å­˜
                        localStorage.setItem('profile', JSON.stringify(profileData));
                        console.log('âœ… ä¸ªäººèµ„æ–™åŠ è½½æˆåŠŸï¼Œæ‰€æœ‰å­—æ®µå·²å¡«å……ï¼ˆåŒ…æ‹¬æ˜¾ç¤ºå…ƒç´ ï¼‰');
                    } else {
                        console.warn('âš ï¸ APIè¿”å›æ•°æ®æ ¼å¼å¼‚å¸¸ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ®');
                        ProfilePage.fill();
                    }
                } else {
                    console.warn('âš ï¸ APIä¸å¯ç”¨ï¼Œä½¿ç”¨ç¼“å­˜æ•°æ®');
                    ProfilePage.fill();
                }
            } catch(e) {
                console.error('âŒ ä»APIåŠ è½½ä¸ªäººèµ„æ–™å¤±è´¥:', e);
                // é™çº§åˆ°æœ¬åœ°ç¼“å­˜
            ProfilePage.fill(); 
            }
            
            ProfilePage.bindLogout();
            
            // ç¶å®šä¿å­˜æŒ‰éˆ•
            var saveBtn = document.getElementById('saveProfileBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', function() {
                    ProfilePage.save();
                });
            }
            
            // ç¶å®šé‡ç½®æŒ‰éˆ•
            var resetBtn = document.getElementById('resetProfileBtn');
            if (resetBtn) {
                resetBtn.addEventListener('click', function() {
                    ProfilePage.reset();
                });
            }
            
            // ğŸ¨ æ¢å¤´åƒåŠŸèƒ½
            var profileAvatar = document.getElementById('profileAvatar');
            var avatarInput = document.getElementById('avatarInput');
            
            if (profileAvatar && avatarInput) {
                // ç‚¹å‡»å¤´åƒè§¦å‘æ–‡ä»¶é€‰æ‹©
                profileAvatar.addEventListener('click', function() {
                    avatarInput.click();
                });
                
                // æ–‡ä»¶é€‰æ‹©åé¢„è§ˆå›¾ç‰‡
                avatarInput.addEventListener('change', function(e) {
                    var file = e.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        var reader = new FileReader();
                        reader.onload = function(event) {
                            var imageUrl = event.target.result;
                            
                            // æ›´æ–°æ‰€æœ‰å¤´åƒæ˜¾ç¤º
                            profileAvatar.style.backgroundImage = 'url(' + imageUrl + ')';
                            profileAvatar.style.backgroundSize = 'cover';
                            profileAvatar.style.backgroundPosition = 'center';
                            profileAvatar.classList.add('has-image');
                            
                            // ä¿å­˜åˆ°localStorageï¼ˆå®é™…é¡¹ç›®ä¸­åº”è¯¥ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼‰
                            try {
                                localStorage.setItem('userAvatar', imageUrl);
                                console.log('âœ… å¤´åƒå·²æ›´æ–°ï¼ˆä¿å­˜åˆ°æœ¬åœ°ï¼‰');
                                alert('å¤´åƒå·²æ›´æ–°ï¼\nï¼ˆæ³¨ï¼šå½“å‰ä¸ºæ¼”ç¤ºæ¨¡å¼ï¼Œå®é™…é¡¹ç›®ä¸­ä¼šä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼‰');
                            } catch(e) {
                                console.error('ä¿å­˜å¤´åƒå¤±è´¥:', e);
                                alert('å¤´åƒæ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©è¾ƒå°çš„å›¾ç‰‡');
                            }
                        };
                        reader.readAsDataURL(file);
                    } else {
                        alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„å›¾ç‰‡æ–‡ä»¶');
                    }
                });
                
                // é¡µé¢åŠ è½½æ—¶æ¢å¤å¤´åƒ
                try {
                    var savedAvatar = localStorage.getItem('userAvatar');
                    if (savedAvatar) {
                        profileAvatar.style.backgroundImage = 'url(' + savedAvatar + ')';
                        profileAvatar.style.backgroundSize = 'cover';
                        profileAvatar.style.backgroundPosition = 'center';
                        profileAvatar.classList.add('has-image');
                    }
                } catch(e) {
                    console.warn('æ¢å¤å¤´åƒå¤±è´¥:', e);
                }
            }
        });
    </script>
</body>
</html>

