<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人信息 - 潘多拉工作日志管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/theme.css">
    <style>
        body { align-items: flex-start; }
        .layout { width: 100%; max-width: 1320px; margin: 32px auto; padding: 0 40px; }
        .topbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .brand { display: flex; align-items: center; gap: 12px; }
        .brand .logo { width: 48px; height: 48px; margin: 0; }
        .brand strong { font-size: 20px; font-family: 'ZCOOL KuaiLe', 'Noto Sans SC', sans-serif; }
        .avatar { width: 72px; height: 72px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, var(--color-peach), var(--color-primary-2)); border: 2px solid #fff; box-shadow: 0 3px 10px rgba(255,138,0,0.25); }
        .avatar:hover .avatar-overlay { opacity: 1 !important; }
        .avatar.has-image { background-size: cover; background-position: center; }
        .panel { background: #fff; border-radius: 14px; padding: 18px; }
        .nav-links { display:flex; gap:10px; }
        .nav-links a { padding:8px 12px; border-radius:10px; background:#fff7ef; border:1px solid #ffd3a1; color:#a55b00; text-decoration:none; }
        .nav-links a:hover { background:#ffe9d2; }
        .panel h3 { margin-bottom: 12px; color: #a55b00; font-family: 'ZCOOL KuaiLe', 'Noto Sans SC', sans-serif; font-size: 22px; text-align:center; }
        .profile-hero { 
            background: linear-gradient(135deg, #fff7ef 0%, #ffe9d2 100%);
            border-radius: 16px;
            padding: 32px 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(255, 138, 0, 0.1);
        }
        .profile-avatar-container { 
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }
        .profile-info { text-align: center; }
        .profile-title { 
            font-size: 24px;
            line-height: 1.2;
            font-weight: 700;
            color: #a55b00;
            margin-bottom: 8px;
        }
        .profile-subtitle { 
            color: #7a5a33;
            font-size: 14px;
            margin-top: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .profile-subtitle i { color: #ff8a00; font-size: 12px; }
        .chips { 
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 16px;
            justify-content: center;
        }
        .chip { 
            padding: 6px 16px;
            border-radius: 20px;
            background: linear-gradient(135deg, #ff8a00 0%, #ffb06b 100%);
            color: white;
            font-size: 13px;
            font-weight: 500;
            box-shadow: 0 2px 6px rgba(255, 138, 0, 0.3);
        }
        .chip:empty { display: none; }
        .profile-form { 
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            max-width: 900px;
            margin: 0 auto;
            background: #fafafa;
            padding: 24px;
            border-radius: 16px;
        }
        .profile-form .full { grid-column: span 2; }
        .form-item { 
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .form-item label { 
            color: #a55b00;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .form-item label i { color: #ff8a00; font-size: 14px; }
        .form-item input, .form-item select, .form-item textarea { 
            padding: 14px 16px;
            border: 2px solid #ffd3a1;
            border-radius: 12px;
            background: #fff;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .form-item input:focus, .form-item select:focus, .form-item textarea:focus {
            outline: none;
            border-color: #ff8a00;
            box-shadow: 0 0 0 3px rgba(255, 138, 0, 0.1);
        }
        .form-item textarea { min-height: 110px; resize: vertical; }
        .row-center { 
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 16px;
        }
        .btn-sm { 
            padding: 14px 40px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-2));
            color: #fff;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(255, 138, 0, 0.3);
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            min-width: 160px;
        }
        .btn-sm:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 138, 0, 0.4);
        }
    </style>
</head>
<body>
    <div class="layout">
        <div class="topbar">
            <div class="brand">
                <div class="logo" style="width: 48px; height: 48px; background: linear-gradient(135deg, #ff8a00 0%, #ffb06b 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(255, 138, 0, 0.3); overflow: hidden; padding: 4px;">
                    <img src="data/picture/LOGO.png" alt="Logo" style="width: 100%; height: 100%; object-fit: contain;">
                </div>
                <strong>个人信息</strong>
            </div>
            <div style="display:flex; align-items:center; gap:16px;">
                <nav class="nav-links">
                    <a href="publish.html">发布任务</a>
                    <a href="dashboard.html">工作日志</a>
                    <a href="users.html">用户管理</a>
                    <a href="tasks.html">任务展示</a>
                    <a href="calendar.html">日程表</a>
                </nav>
                <div class="profile" onclick="location.href='profile.html'" style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                <span id="currentUserName">用户</span>
                <div class="avatar" style="width:40px;height:40px;"></div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="profile-hero">
                <div class="profile-avatar-container">
                    <div class="avatar profile-avatar" id="profileAvatar" style="position: relative; cursor: pointer;" title="点击更换头像">
                        <input type="file" id="avatarInput" accept="image/*" style="display: none;">
                        <div class="avatar-overlay" style="position: absolute; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.6); color: white; text-align: center; padding: 4px; font-size: 11px; border-radius: 0 0 50% 50%; opacity: 0; transition: opacity 0.3s;">
                            <i class="fas fa-camera"></i> 更换
                        </div>
                    </div>
                    <div class="profile-info">
                        <div class="profile-title"><strong id="p_username">用户名</strong></div>
                        <div class="profile-subtitle">
                            <i class="fas fa-user-tag"></i>
                            <span id="p_employeeId">角色</span>
                        </div>
                        <div class="profile-subtitle">
                            <i class="fas fa-envelope"></i>
                            <span id="p_email">邮箱</span>
                        </div>
                        <div class="profile-subtitle">
                            <i class="fas fa-users"></i>
                            <span id="p_company">团队</span>
                        </div>
                    </div>
                </div>
                <div class="chips">
                    <span class="chip" id="chip_gender"></span>
                    <span class="chip" id="chip_age"></span>
                </div>
            </div>
            <form id="profileForm" class="profile-form">
                <div class="form-item">
                    <label><i class="fas fa-id-card"></i> 姓名</label>
                    <input id="pf_name" placeholder="请输入姓名">
                </div>
                <div class="form-item">
                    <label><i class="fas fa-envelope"></i> 邮箱</label>
                    <input id="pf_email" type="email" placeholder="请输入邮箱">
                </div>
                <div class="form-item">
                    <label><i class="fas fa-phone"></i> 手机号</label>
                    <input id="pf_phone" type="tel" placeholder="请输入手机号">
                </div>
                <div class="form-item">
                    <label><i class="fas fa-venus-mars"></i> 性别</label>
                    <select id="pf_gender">
                        <option value="">保密</option>
                        <option value="男">男</option>
                        <option value="女">女</option>
                    </select>
                </div>
                <div class="form-item">
                    <label><i class="fas fa-calendar-alt"></i> 出生年月</label>
                    <input id="pf_birth" type="date">
                </div>
                <div class="form-item">
                    <label><i class="fas fa-birthday-cake"></i> 年龄</label>
                    <input id="pf_age" type="number" min="0" max="120" placeholder="自动计算" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-item">
                    <label><i class="fas fa-users"></i> 所属团队</label>
                    <input id="pf_team" placeholder="团队信息" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-item">
                    <label><i class="fas fa-user-tie"></i> 担任职位</label>
                    <input id="pf_role" placeholder="职位信息" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-item full">
                    <label><i class="fas fa-quote-left"></i> 个人简介</label>
                    <textarea id="pf_bio" placeholder="介绍一下自己吧"></textarea>
                </div>
                <div class="row-center full">
                    <button type="button" class="btn-sm" id="saveProfileBtn">
                        <i class="fas fa-save"></i> 保存
                    </button>
                    <button type="button" class="btn-sm" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i> 退出登录
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script src="js/api.js"></script>
    <script src="js/profile.js"></script>
    <script>
        // 五级身份映射
        const roleMap = {
            1: 'CEO',
            2: 'Manager',
            3: 'Team Leader',
            4: 'Member',
            5: 'Admin'
        };
        
        // 性别映射
        const genderMap = {
            'M': '男',
            'F': '女',
            '男': '男',
            '女': '女'
        };
        
        document.addEventListener('DOMContentLoaded', async function(){ 
            // 从真实API加载个人资料
            try {
                if(window.API && typeof window.API.getProfile === 'function'){
                    console.log('从API加载个人资料...');
                    var profileData = await window.API.getProfile();
                    console.log('API返回的个人资料:', profileData);
                    

                    var userData = profileData.user || profileData;
                    console.log('用户数据:', userData);
                    console.log('team字段:', userData.team);
                    console.log('role_id字段:', userData.role_id);
                    
                    if(userData && (userData.user_id || userData.name)) {
                        // 填充表单（使用正确的ID）
                        console.log('开始填充表单，数据:', userData);
                        
                        document.getElementById('pf_name').value = userData.name || '';
                        document.getElementById('pf_email').value = userData.email || '';
                        
                        var phoneField = document.getElementById('pf_phone');
                        if(phoneField) phoneField.value = userData.phone || '';
                        
                        // 性别字段 - 转换M/F为中文
                        var genderField = document.getElementById('pf_gender');
                        if(genderField && userData.gender) {
                            var genderValue = genderMap[userData.gender] || userData.gender;
                            genderField.value = genderValue;
                        }
                        
                        // 日期字段 - 转换格式 "2025-10-25T06:36:31" -> "2025-10-25"
                        var birthField = document.getElementById('pf_birth');
                        if(birthField) {
                            var birthDate = userData.birthday || userData.birth_date;
                            if(birthDate) {
                                // 提取日期部分（YYYY-MM-DD）
                                var dateOnly = birthDate.split('T')[0];
                                birthField.value = dateOnly;
                                console.log('生日字段设置为:', dateOnly);
                            }
                        }
                        
                        // 年龄字段已在上面通过出生日期自动计算并填充
                        
                        // 获取并显示团队名称（使用getTeamName接口）
                        var teamDisplay = '加载中...';
                        var teamId = userData.team || userData.team_id || userData.teamId;
                        console.log('团队ID (userData.team):', teamId);
                        
                        if(teamId) {
                            console.log('获取团队名称，teamId:', teamId);
                            try {
                                teamDisplay = await window.API.getTeamNameCached(teamId);
                                console.log('团队名称:', teamDisplay);
                            } catch(error) {
                                console.error('获取团队名称失败:', error);
                                teamDisplay = '未知团队';
                            }
                        } else {
                            teamDisplay = '未分配团队';
                        }
                        
                        // 显示角色名称（使用五级身份映射）
                        var roleId = userData.role_id || userData.roleId;
                        var roleDisplay = roleMap[roleId] || '未知角色';
                        console.log('角色ID:', roleId, '→ 角色名称:', roleDisplay);
                        
                        // 填充所属团队字段
                        var teamField = document.getElementById('pf_team');
                        if(teamField) {
                            teamField.value = teamDisplay;
                            console.log('所属团队字段已填充:', teamDisplay);
                        } else {
                            console.error('找不到pf_team字段');
                        }
                        
                        // 填充担任职位字段
                        var roleField = document.getElementById('pf_role');
                        if(roleField) {
                            roleField.value = roleDisplay;
                            console.log('担任职位字段已填充:', roleDisplay);
                        } else {
                            console.error('找不到pf_role字段');
                        }
                        
                        // 个人简介字段
                        var bioField = document.getElementById('pf_bio');
                        if(bioField) {
                            bioField.value = userData.bio || '';
                        }
                        
                        // 关键修复：更新头像下方的显示元素
                        // 头像下方显示username（不是name）
                        var pUsernameElem = document.getElementById('p_username');
                        if(pUsernameElem) pUsernameElem.textContent = userData.username || '用户名';
                        
                        var pEmailElem = document.getElementById('p_email');
                        if(pEmailElem) pEmailElem.textContent = userData.email || '';
                        
                        // 显示角色信息
                        var pEmployeeIdElem = document.getElementById('p_employeeId');
                        if(pEmployeeIdElem) pEmployeeIdElem.textContent = roleDisplay;
                        
                        // 显示团队信息
                        var pCompanyElem = document.getElementById('p_company');
                        if(pCompanyElem) pCompanyElem.textContent = teamDisplay;
                        
                        // 自动计算年龄并更新chips显示
                        var chipGender = document.getElementById('chip_gender');
                        if(chipGender) {
                            var genderDisplay = genderMap[userData.gender] || userData.gender || '';
                            chipGender.textContent = genderDisplay;
                        }
                        
                        // 根据出生日期自动计算年龄
                        var calculatedAge = null;
                        var birthDate = userData.birthday || userData.birth_date;
                        if(birthDate) {
                            var birth = new Date(birthDate);
                            var today = new Date();
                            calculatedAge = today.getFullYear() - birth.getFullYear();
                            var monthDiff = today.getMonth() - birth.getMonth();
                            if(monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
                                calculatedAge--;
                            }
                            console.log('计算年龄: 出生日期=' + birthDate + ', 年龄=' + calculatedAge);
                        }
                        
                        var chipAge = document.getElementById('chip_age');
                        if(chipAge && calculatedAge !== null && calculatedAge >= 0) {
                            chipAge.textContent = calculatedAge + '岁';
                        }
                        
                        // 自动填充年龄到表单
                        var ageField = document.getElementById('pf_age');
                        if(ageField && calculatedAge !== null && calculatedAge >= 0) {
                            ageField.value = calculatedAge;
                        }
                        
                        //  更新顶部导航栏的用户名显示
                        var currentUserNameElem = document.getElementById('currentUserName');
                        if(currentUserNameElem) currentUserNameElem.textContent = userData.name || '用户';
                        
                        // 同步更新currentUser到localStorage（确保其他页面也能获取到最新用户信息）
                        try {
                            var currentUser = {
                                name: userData.name || '',
                                email: userData.email || '',
                                employeeId: userData.employeeId || userData.employee_id || '',
                                user_id: userData.user_id || userData.id || '',
                                id: userData.user_id || userData.id || ''
                            };
                            localStorage.setItem('currentUser', JSON.stringify(currentUser));
                            console.log('currentUser已同步更新:', currentUser);
                        } catch(e) {
                            console.warn('⚠currentUser更新失败:', e);
                        }
                        
                        // 保存到localStorage作为缓存（包含团队和角色的显示名称）
                        var cacheData = Object.assign({}, userData, {
                            teamName: teamDisplay,
                            roleName: roleDisplay,
                            team_id: teamId,  // 保存team_id以便后续更新使用
                            role_id: roleId   // 保存role_id以便后续更新使用
                        });
                        localStorage.setItem('profile', JSON.stringify(cacheData));
                        console.log('个人资料加载成功，所有字段已填充（包括显示元素）');
                    } else {
                        console.warn('⚠API返回数据格式异常，使用缓存数据');
                        ProfilePage.fill();
                    }
                } else {
                    console.warn('⚠API不可用，使用缓存数据');
                    ProfilePage.fill();
                }
            } catch(e) {
                console.error('从API加载个人资料失败:', e);
                // 降级到本地缓存
            ProfilePage.fill(); 
            }
            
            // 綁定保存按鈕
            var saveBtn = document.getElementById('saveProfileBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', function() {
                    ProfilePage.save();
                });
            }
            
            // 綁定退出登录按鈕
            var logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', function() {
                    if (confirm('确定要退出登录吗？')) {
                        try {
                            localStorage.removeItem('authToken');
                            localStorage.removeItem('currentUser');
                        } catch(e) {}
                        location.href = 'index.html';
                    }
                });
            }
            
            // 换头像功能
            var profileAvatar = document.getElementById('profileAvatar');
            var avatarInput = document.getElementById('avatarInput');
            
            if (profileAvatar && avatarInput) {
                // 点击头像触发文件选择
                profileAvatar.addEventListener('click', function() {
                    avatarInput.click();
                });
                
                // 文件选择后预览图片
                avatarInput.addEventListener('change', function(e) {
                    var file = e.target.files[0];
                    if (file && file.type.startsWith('image/')) {
                        var reader = new FileReader();
                        reader.onload = function(event) {
                            var imageUrl = event.target.result;
                            
                            // 更新所有头像显示
                            profileAvatar.style.backgroundImage = 'url(' + imageUrl + ')';
                            profileAvatar.style.backgroundSize = 'cover';
                            profileAvatar.style.backgroundPosition = 'center';
                            profileAvatar.classList.add('has-image');
                            
                            // 保存到localStorage（实际项目中应该上传到服务器）
                            try {
                                localStorage.setItem('userAvatar', imageUrl);
                                console.log('头像已更新（保存到本地）');
                                alert('头像已更新！\n（注：当前为演示模式，实际项目中会上传到服务器）');
                            } catch(e) {
                                console.error('保存头像失败:', e);
                                alert('头像文件过大，请选择较小的图片');
                            }
                        };
                        reader.readAsDataURL(file);
                    } else {
                        alert('请选择有效的图片文件');
                    }
                });
                
                // 页面加载时恢复头像
                try {
                    var savedAvatar = localStorage.getItem('userAvatar');
                    if (savedAvatar) {
                        profileAvatar.style.backgroundImage = 'url(' + savedAvatar + ')';
                        profileAvatar.style.backgroundSize = 'cover';
                        profileAvatar.style.backgroundPosition = 'center';
                        profileAvatar.classList.add('has-image');
                    }
                } catch(e) {
                    console.warn('恢复头像失败:', e);
                }
            }
        });
    </script>
</body>
</html>

