<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥ç¨‹è¡¨ - æ½˜å¤šæ‹‰å·¥ä½œæ—¥å¿—ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/theme.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { align-items: flex-start; background: linear-gradient(135deg, #fff7ef 0%, #ffe9d2 100%); }
        .layout { width: 100%; max-width: 1400px; margin: 32px auto; padding: 0 40px; }
        .topbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
        .brand { display: flex; align-items: center; gap: 12px; }
        .brand .logo { width: 48px; height: 48px; margin: 0; }
        .brand strong { font-size: 22px; font-family: 'ZCOOL KuaiLe', 'Noto Sans SC', sans-serif; color: #a55b00; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, var(--color-peach), var(--color-primary-2)); border: 2px solid #fff; box-shadow: 0 3px 10px rgba(255,138,0,0.25); }
        .panel { background: #fff; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .nav-links { display:flex; gap:10px; flex-wrap:wrap; }
        .nav-links a { padding:8px 14px; border-radius:10px; background:#fff7ef; border:1px solid #ffd3a1; color:#a55b00; text-decoration:none; font-weight:500; transition: all 0.3s; }
        .nav-links a:hover { background:#ffbe78; color:#fff; transform: translateY(-2px); }
        .panel h3 { margin: 0 0 20px 0; color: #a55b00; font-family: 'ZCOOL KuaiLe', 'Noto Sans SC', sans-serif; font-size: 24px; border-bottom: 3px solid #ffd3a1; padding-bottom: 12px; }
        
        /* å…¬å¸é‡è¦äº‹é¡¹ */
        .important-tasks { background: linear-gradient(135deg, #fff7ef 0%, #ffe8cf 100%); border: 2px solid #ffbe78; border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .important-tasks h4 { color: #ff8a00; margin: 0 0 16px 0; font-size: 18px; display: flex; align-items: center; gap: 8px; }
        .important-tasks h4 i { font-size: 20px; }
        .important-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; }
        .important-item { background: #fff; border: 1px solid #ffd3a1; border-radius: 8px; padding: 12px; font-size: 14px; color: #7a5a33; display: flex; align-items: center; gap: 8px; transition: all 0.3s; }
        .important-item:hover { border-color: #ff8a00; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(255,138,0,0.2); }
        .important-item i { color: #ff8a00; }
        
        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 16px; margin-bottom: 24px; }
        @media (max-width: 1400px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 900px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .stats-grid { grid-template-columns: 1fr; } }
        .stat-card { background: linear-gradient(135deg, var(--color-cream) 0%, var(--color-peach) 100%); border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #ffd3a1; transition: all 0.3s; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 6px 16px rgba(255,138,0,0.3); }
        .stat-number { font-size: 36px; font-weight: 700; color: var(--color-primary); margin-bottom: 8px; }
        .stat-label { font-size: 14px; color: #7a5a33; font-weight: 500; }
        .stat-icon { font-size: 24px; margin-bottom: 8px; }
        
        /* æ—¥å†æ ·å¼ */
        .calendar-section { display: grid; grid-template-columns: 1fr 350px; gap: 24px; }
        @media (max-width: 1100px) { .calendar-section { grid-template-columns: 1fr; } }
        .calendar { background: #fff; border-radius: 14px; padding: 20px; border: 2px solid #ffd3a1; }
        .calendar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .calendar-header h4 { color: #a55b00; margin: 0; font-size: 18px; }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-bottom: 8px; }
        .weekday { text-align: center; padding: 8px; font-weight: 600; color: #ff8a00; font-size: 13px; }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .day-cell { background: #fff7ef; border: 1px solid #ffd3a1; min-height: 80px; border-radius: 8px; padding: 6px; font-size: 13px; color: #7a5a33; position: relative; cursor: pointer; transition: all 0.2s; }
        .day-cell:hover { background: #ffe9d2; border-color: #ff8a00; transform: scale(1.05); }
        .day-cell.today { background: linear-gradient(135deg, #ffe8cf 0%, #ffd3a1 100%); border: 2px solid #ff8a00; font-weight: 700; }
        .day-cell.other-month { background: #f5f5f5; color: #ccc; }
        .day-number { font-weight: 600; margin-bottom: 4px; }
        .day-indicators { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
        .indicator { width: 6px; height: 6px; border-radius: 50%; }
        .indicator.task { background: #ff8a00; }
        .indicator.log { background: #4CAF50; }
        .indicator.deadline { background: #F44336; }
        
        /* ä¾§è¾¹æ  */
        .sidebar-section { background: #fff; border-radius: 14px; padding: 20px; border: 2px solid #ffd3a1; }
        .sidebar-section h4 { color: #a55b00; margin: 0 0 16px 0; font-size: 16px; border-bottom: 2px solid #ffd3a1; padding-bottom: 8px; }
        .today-summary { margin-bottom: 16px; }
        .summary-item { display: flex; justify-content: space-between; padding: 10px; background: #fff7ef; border-radius: 8px; margin-bottom: 8px; }
        .summary-label { color: #7a5a33; font-size: 13px; }
        .summary-value { color: #ff8a00; font-weight: 600; font-size: 14px; }
        
        /* å›¾è¡¨ */
        .charts-section { margin-top: 24px; }
        .charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
        @media (max-width: 900px) { .charts-grid { grid-template-columns: 1fr; } }
        .chart-container { background: #fff; border: 2px solid #ffd3a1; border-radius: 14px; padding: 20px; }
        .chart-title { color: #a55b00; font-weight: 600; margin-bottom: 16px; text-align: center; font-size: 16px; }
        .chart-canvas { position: relative; height: 280px; }
        
        /* ä»»åŠ¡åˆ—è¡¨ */
        .task-list { max-height: 400px; overflow-y: auto; }
        .task-item { background: #fff7ef; border: 1px solid #ffd3a1; border-radius: 8px; padding: 12px; margin-bottom: 8px; transition: all 0.3s; }
        .task-item:hover { background: #ffe9d2; border-color: #ff8a00; transform: translateX(4px); }
        .task-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .task-title { font-weight: 600; color: #333; font-size: 14px; }
        .task-priority { padding: 2px 8px; border-radius: 4px; font-size: 11px; }
        .task-priority.high { background: #ffebee; color: #c62828; }
        .task-priority.medium { background: #fff3e0; color: #e65100; }
        .task-priority.low { background: #e8f5e9; color: #2e7d32; }
        .task-meta { font-size: 12px; color: #7a5a33; }
        .task-progress-bar { height: 6px; background: #ffd3a1; border-radius: 3px; overflow: hidden; margin-top: 6px; }
        .task-progress-fill { height: 100%; background: linear-gradient(90deg, #ff8a00 0%, #ffbe78 100%); transition: width 0.3s; }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading { text-align: center; padding: 40px; color: #7a5a33; }
        .loading i { font-size: 32px; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* æ—¥æœŸè¯¦æƒ…æ¨¡æ€æ¡† */
        .day-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow: auto; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .day-modal-content { background: #fff; margin: 5% auto; padding: 0; border-radius: 16px; max-width: 800px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); animation: slideDown 0.3s; }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .day-modal-header { background: linear-gradient(135deg, #ff8a00 0%, #ff6b00 100%); color: white; padding: 24px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .day-modal-header h2 { margin: 0; font-family: 'ZCOOL KuaiLe', 'Noto Sans SC', sans-serif; font-size: 22px; }
        .day-modal-close { background: transparent; border: none; color: white; font-size: 28px; cursor: pointer; padding: 0; width: 32px; height: 32px; line-height: 28px; border-radius: 50%; transition: all 0.3s; }
        .day-modal-close:hover { background: rgba(255,255,255,0.2); transform: rotate(90deg); }
        .day-modal-body { padding: 24px; max-height: 70vh; overflow-y: auto; }
        .day-section { margin-bottom: 24px; }
        .day-section-title { color: #a55b00; font-size: 18px; font-weight: 600; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #ffd3a1; display: flex; align-items: center; gap: 8px; }
        .detail-card { background: linear-gradient(135deg, #fff7ef 0%, #ffe9d2 100%); border: 2px solid #ffd3a1; border-radius: 12px; padding: 16px; margin-bottom: 12px; transition: all 0.3s; }
        .detail-card:hover { border-color: #ff8a00; box-shadow: 0 4px 12px rgba(255,138,0,0.2); transform: translateX(4px); }
        .detail-card-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
        .detail-title { font-size: 16px; font-weight: 600; color: #333; flex: 1; }
        .detail-badges { display: flex; gap: 8px; align-items: center; }
        .badge { padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 500; }
        .badge.priority-high { background: #ffebee; color: #c62828; }
        .badge.priority-medium { background: #fff3e0; color: #e65100; }
        .badge.priority-low { background: #e8f5e9; color: #2e7d32; }
        .badge.status { background: #e3f2fd; color: #1565c0; }
        .detail-info { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 12px; }
        .info-item { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #7a5a33; }
        .info-item i { color: #ff8a00; width: 16px; }
        .detail-description { margin-top: 12px; padding-top: 12px; border-top: 1px dashed #ffd3a1; color: #555; font-size: 14px; line-height: 1.6; }
        .progress-section { margin-top: 12px; }
        .progress-label { font-size: 12px; color: #7a5a33; margin-bottom: 4px; }
        .progress-bar-wrapper { height: 8px; background: #ffd3a1; border-radius: 4px; overflow: hidden; }
        .progress-bar-inner { height: 100%; background: linear-gradient(90deg, #ff8a00 0%, #ffbe78 100%); transition: width 0.3s; }
        .log-card { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #81c784; border-radius: 12px; padding: 16px; margin-bottom: 12px; }
        .log-card:hover { border-color: #4caf50; box-shadow: 0 4px 12px rgba(76,175,80,0.2); }
        .log-title { font-size: 16px; font-weight: 600; color: #2e7d32; margin-bottom: 8px; }
        .log-meta { font-size: 13px; color: #558b2f; }
        .empty-state { text-align: center; padding: 40px; color: #999; }
        .empty-state i { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
    </style>
</head>
<body>
    <div class="layout">
        <div class="topbar">
            <div class="brand">
                <div class="logo" style="width: 48px; height: 48px; background: linear-gradient(135deg, #ff8a00 0%, #ffb06b 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(255, 138, 0, 0.3); overflow: hidden; padding: 4px;">
                    <img src="data/picture/LOGO.png" alt="Logo" style="width: 100%; height: 100%; object-fit: contain;">
                </div>
                <strong>å·¥ä½œæ—¥ç¨‹è¡¨</strong>
            </div>
            <div style="display:flex; align-items:center; gap:16px;">
                <nav class="nav-links">
                    <a href="publish.html"><i class="fas fa-plus-circle"></i> å‘å¸ƒä»»åŠ¡</a>
                    <a href="dashboard.html"><i class="fas fa-book"></i> å·¥ä½œæ—¥å¿—</a>
                    <a href="users.html"><i class="fas fa-users"></i> ç”¨æˆ·ç®¡ç†</a>
                    <a href="tasks.html"><i class="fas fa-tasks"></i> ä»»åŠ¡å±•ç¤º</a>
                    <a href="profile.html"><i class="fas fa-user"></i> ä¸ªäººä¿¡æ¯</a>
                </nav>
                <div class="profile" onclick="location.href='profile.html'" style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                <span id="currentUserName">ç”¨æˆ·</span>
                <div class="avatar"></div>
                </div>
            </div>
        </div>

        <!-- å…¬å¸é‡è¦äº‹é¡¹ -->
        <div class="panel">
            <div class="important-tasks">
                <h4><i class="fas fa-star"></i> å…¬å¸é‡è¦äº‹é¡¹</h4>
                <div id="importantTasksList" class="important-list">
                    <div class="loading"><i class="fas fa-spinner"></i> åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡æ•°æ® -->
        <div class="panel">
            <h3><i class="fas fa-chart-bar"></i> æ•°æ®ç»Ÿè®¡æ¦‚è§ˆ</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-tasks"></i></div>
                    <div class="stat-number" id="totalTasks">0</div>
                    <div class="stat-label">æ€»ä»»åŠ¡æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="stat-number" id="completedTasks">0</div>
                    <div class="stat-label">å·²å®Œæˆä»»åŠ¡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-spinner"></i></div>
                    <div class="stat-number" id="inProgressTasks">0</div>
                    <div class="stat-label">è¿›è¡Œä¸­ä»»åŠ¡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-clock"></i></div>
                    <div class="stat-number" id="pendingTasks">0</div>
                    <div class="stat-label">å¾…å¼€å§‹ä»»åŠ¡</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-book-open"></i></div>
                    <div class="stat-number" id="totalLogs">0</div>
                    <div class="stat-label">å·¥ä½œæ—¥å¿—æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-users"></i></div>
                    <div class="stat-number" id="totalUsers">0</div>
                    <div class="stat-label">å›¢é˜Ÿæˆå‘˜æ•°</div>
                </div>
                </div>
            </div>
            
        <!-- æ—¥å†å’Œä¾§è¾¹æ  -->
        <div class="calendar-section">
            <div class="calendar">
                <div class="calendar-header">
                    <h4 id="calendarTitle">æœ¬æœˆæ—¥ç¨‹</h4>
                    <div>
                        <button onclick="previousMonth()" style="padding:6px 12px; border:1px solid #ffd3a1; background:#fff; border-radius:6px; cursor:pointer; margin-right:8px;"><i class="fas fa-chevron-left"></i></button>
                        <button onclick="nextMonth()" style="padding:6px 12px; border:1px solid #ffd3a1; background:#fff; border-radius:6px; cursor:pointer;"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <div class="calendar-weekdays">
                    <div class="weekday">å‘¨æ—¥</div>
                    <div class="weekday">å‘¨ä¸€</div>
                    <div class="weekday">å‘¨äºŒ</div>
                    <div class="weekday">å‘¨ä¸‰</div>
                    <div class="weekday">å‘¨å››</div>
                    <div class="weekday">å‘¨äº”</div>
                    <div class="weekday">å‘¨å…­</div>
                </div>
                <div id="calendarGrid" class="calendar-days"></div>
            </div>
            
            <div class="sidebar-section">
                <h4><i class="fas fa-calendar-day"></i> ä»Šæ—¥æ¦‚è§ˆ</h4>
                <div class="today-summary">
                    <div class="summary-item">
                        <span class="summary-label">ä»Šæ—¥ä»»åŠ¡</span>
                        <span class="summary-value" id="todayTasks">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">ä»Šæ—¥æ—¥å¿—</span>
                        <span class="summary-value" id="todayLogs">0</span>
                        </div>
                    <div class="summary-item">
                        <span class="summary-label">å³å°†åˆ°æœŸ</span>
                        <span class="summary-value" id="upcomingDeadlines">0</span>
                    </div>
                </div>
                <h4 style="margin-top:20px;"><i class="fas fa-fire"></i> è¿‘æœŸä»»åŠ¡</h4>
                <div id="recentTasksList" class="task-list">
                    <div class="loading"><i class="fas fa-spinner"></i> åŠ è½½ä¸­...</div>
                </div>
            </div>
        </div>

        <!-- å›¾è¡¨ç»Ÿè®¡ -->
        <div class="panel charts-section">
            <h3><i class="fas fa-chart-pie"></i> æ•°æ®å¯è§†åŒ–åˆ†æ</h3>
                <div class="charts-grid">
                    <div class="chart-container">
                    <div class="chart-title">ä»»åŠ¡çŠ¶æ€åˆ†å¸ƒ</div>
                        <div class="chart-canvas">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                    <div class="chart-title">ä»»åŠ¡ä¼˜å…ˆçº§åˆ†å¸ƒ</div>
                        <div class="chart-canvas">
                        <canvas id="priorityChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                <div class="chart-title">æ¯æœˆä»»åŠ¡ä¸æ—¥å¿—è¶‹åŠ¿</div>
                <div class="chart-canvas" style="height: 300px;">
                    <canvas id="trendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

    <!-- æ—¥æœŸè¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="dayModal" class="day-modal">
        <div class="day-modal-content">
            <div class="day-modal-header">
                <h2 id="modalDateTitle">2025-11-08</h2>
                <button class="day-modal-close" onclick="closeDayModal()">&times;</button>
            </div>
            <div class="day-modal-body" id="modalBody">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script src="js/api.js"></script>
    <script>
        // è®¾ç½®ç”¨æˆ·å
        try { const raw=localStorage.getItem('currentUser'); const u=raw?JSON.parse(raw):{name:'ç”¨æˆ·'}; document.getElementById('currentUserName').textContent=u.name||'ç”¨æˆ·'; } catch(e){}
        
        // å…¨å±€æ•°æ®å­˜å‚¨
        let allTasks = [];
        let allLogs = [];
        let allUsers = [];
        let currentDate = new Date();
        let calendarData = {}; // æ—¥æœŸ -> {tasks, logs}
        
        // å›¾è¡¨å®ä¾‹
        let pieChart, priorityChart, trendChart;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('æ—¥ç¨‹è¡¨é¡µé¢åŠ è½½...');
            await loadAllData();
            initCharts();
            renderCalendar();
            renderStats();
            renderTodaySummary();
            renderRecentTasks();
            updateCharts();
            loadImportantTasks();
        });
        
        // åŠ è½½æ‰€æœ‰æ•°æ®
        async function loadAllData() {
            try {
                console.log('å¼€å§‹åŠ è½½æ‰€æœ‰æ•°æ®...');
                
                // å¹¶è¡ŒåŠ è½½æ‰€æœ‰æ•°æ®
                const [tasksData, logsData, usersData] = await Promise.all([
                    loadAllTasks(),
                    loadAllLogs(),
                    loadAllUsers()
                ]);
                
                allTasks = tasksData;
                allLogs = logsData;
                allUsers = usersData;
                
                console.log('æ•°æ®åŠ è½½å®Œæˆ:', {
                    tasks: allTasks.length,
                    logs: allLogs.length,
                    users: allUsers.length
                });
                
                // æ„å»ºæ—¥å†æ•°æ®
                buildCalendarData();
                
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // åŠ è½½æ‰€æœ‰ä»»åŠ¡ï¼ˆåˆ†é¡µå¾ªç¯è·å–ï¼‰
        async function loadAllTasks() {
            const tasks = [];
            let page = 1;
            const pageSize = 10000;
            
            try {
                while (true) {
                    console.log(`åŠ è½½ä»»åŠ¡ç¬¬${page}é¡µ...`);
                    const response = await window.API.listTasks({ page, pageSize });
                    
                    if (!response || !response.list || response.list.length === 0) {
                        break;
                    }
                    
                    tasks.push(...response.list);
                    
                    // å¦‚æœå½“å‰é¡µæ•°æ®å°‘äºpageSizeï¼Œè¯´æ˜æ˜¯æœ€åä¸€é¡µ
                    if (response.list.length < pageSize) {
                        break;
                    }
                    
                    page++;
                    
                    // é˜²æ­¢æ— é™å¾ªç¯
                    if (page > 100) {
                        console.warn('âš ä»»åŠ¡é¡µæ•°è¶…è¿‡100ï¼Œåœæ­¢åŠ è½½');
                        break;
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ä»»åŠ¡å¤±è´¥:', error);
            }
            
            return tasks;
        }
        
        // åŠ è½½æ‰€æœ‰æ—¥å¿—
        async function loadAllLogs() {
            try {
                console.log('åŠ è½½æ‰€æœ‰æ—¥å¿—...');
                const response = await window.API.getJournals({});
                return response && response.list ? response.list : [];
            } catch (error) {
                console.error('åŠ è½½æ—¥å¿—å¤±è´¥:', error);
                return [];
            }
        }
        
        // åŠ è½½æ‰€æœ‰ç”¨æˆ·ï¼ˆåˆ†é¡µå¾ªç¯è·å–ï¼‰
        async function loadAllUsers() {
            const users = [];
            let page = 1;
            const pageSize = 10000;
            
            try {
                while (true) {
                    console.log(`ğŸ‘¥ åŠ è½½ç”¨æˆ·ç¬¬${page}é¡µ...`);
                    const response = await window.API.listUsers({ page, pageSize });
                    
                    if (!response || !response.list || response.list.length === 0) {
                        break;
                    }
                    
                    users.push(...response.list);
                    
                    if (response.list.length < pageSize) {
                        break;
                    }
                    
                    page++;
                    
                    if (page > 100) {
                        console.warn('âš ç”¨æˆ·é¡µæ•°è¶…è¿‡100ï¼Œåœæ­¢åŠ è½½');
                        break;
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·å¤±è´¥:', error);
            }
            
            return users;
        }
        
        // æ„å»ºæ—¥å†æ•°æ®
        function buildCalendarData() {
            calendarData = {};
            
            // å¤„ç†ä»»åŠ¡
            allTasks.forEach(task => {
                if (task.dueAt || task.due_at) {
                    const dateStr = formatDateKey(task.dueAt || task.due_at);
                    if (!calendarData[dateStr]) {
                        calendarData[dateStr] = { tasks: [], logs: [] };
                    }
                    calendarData[dateStr].tasks.push(task);
                }
            });
            
            // å¤„ç†æ—¥å¿—
            allLogs.forEach(log => {
                if (log.log_date || log.date) {
                    const dateStr = formatDateKey(log.log_date || log.date);
                    if (!calendarData[dateStr]) {
                        calendarData[dateStr] = { tasks: [], logs: [] };
                    }
                    calendarData[dateStr].logs.push(log);
                }
            });
            
            console.log('æ—¥å†æ•°æ®æ„å»ºå®Œæˆ:', Object.keys(calendarData).length, 'å¤©æœ‰æ•°æ®');
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸä¸º YYYY-MM-DD
        function formatDateKey(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return '';
            return date.toISOString().split('T')[0];
        }
        
        // æ¸²æŸ“æ—¥å†
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // æ›´æ–°æ ‡é¢˜
            document.getElementById('calendarTitle').textContent = `${year}å¹´${month + 1}æœˆ`;
            
            // è·å–æœˆä»½ç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const firstDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            // è·å–ä¸Šä¸ªæœˆçš„å¤©æ•°
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
            const todayDate = today.getDate();
            
            // å¡«å……ä¸Šä¸ªæœˆçš„æ—¥æœŸ
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonthLastDay - i;
                const cell = document.createElement('div');
                cell.className = 'day-cell other-month';
                cell.innerHTML = `<div class="day-number">${day}</div>`;
                grid.appendChild(cell);
            }
            
            // å¡«å……å½“å‰æœˆçš„æ—¥æœŸ
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                if (isCurrentMonth && day === todayDate) {
                    cell.classList.add('today');
                }
                
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = calendarData[dateStr] || { tasks: [], logs: [] };
                
                let indicators = '';
                if (dayData.tasks.length > 0) {
                    indicators += '<div class="indicator task" title="æœ‰ä»»åŠ¡"></div>'.repeat(Math.min(dayData.tasks.length, 3));
                }
                if (dayData.logs.length > 0) {
                    indicators += '<div class="indicator log" title="æœ‰æ—¥å¿—"></div>'.repeat(Math.min(dayData.logs.length, 3));
                }
                
                cell.innerHTML = `
                    <div class="day-number">${day}</div>
                    <div class="day-indicators">${indicators}</div>
                `;
                
                cell.onclick = () => showDayDetails(dateStr, dayData);
                grid.appendChild(cell);
            }
            
            // å¡«å……ä¸‹ä¸ªæœˆçš„æ—¥æœŸ
            const remainingCells = 42 - (firstDayOfWeek + daysInMonth);
            for (let day = 1; day <= remainingCells; day++) {
                const cell = document.createElement('div');
                cell.className = 'day-cell other-month';
                cell.innerHTML = `<div class="day-number">${day}</div>`;
                grid.appendChild(cell);
            }
        }
        
        // æ˜¾ç¤ºæŸå¤©çš„è¯¦æƒ…ï¼ˆä½¿ç”¨ç²¾ç¾æ¨¡æ€æ¡†ï¼‰
        async function showDayDetails(dateStr, dayData) {
            const modal = document.getElementById('dayModal');
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalDateTitle');
            
            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modal.style.display = 'block';
            modalTitle.textContent = dateStr;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            modalBody.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>åŠ è½½ä¸­...</p>
                </div>
            `;
            
            try {
                // åŠ è½½å®Œæ•´çš„ä»»åŠ¡è¯¦æƒ…
                const tasksWithDetails = await Promise.all(
                    dayData.tasks.map(async task => {
                        try {
                            const detail = await window.API.getTask(task.id);
                            return detail || task;
                        } catch (err) {
                            console.warn(`ä»»åŠ¡${task.id}è¯¦æƒ…åŠ è½½å¤±è´¥:`, err);
                            return task;
                        }
                    })
                );
                
                // æ¸²æŸ“è¯¦æƒ…
                let content = '';
                
                // ä»»åŠ¡éƒ¨åˆ†
                if (tasksWithDetails.length > 0) {
                    content += `
                        <div class="day-section">
                            <div class="day-section-title">
                                <i class="fas fa-tasks"></i>
                                ä»»åŠ¡åˆ—è¡¨ (${tasksWithDetails.length})
                            </div>
                            ${tasksWithDetails.map(task => renderTaskDetail(task)).join('')}
                        </div>
                    `;
                }
                
                // æ—¥å¿—éƒ¨åˆ†
                if (dayData.logs.length > 0) {
                    content += `
                        <div class="day-section">
                            <div class="day-section-title">
                                <i class="fas fa-book"></i>
                                æ—¥å¿—è®°å½• (${dayData.logs.length})
                            </div>
                            ${dayData.logs.map(log => renderLogDetail(log)).join('')}
                        </div>
                    `;
                }
                
                // ç©ºçŠ¶æ€
                if (tasksWithDetails.length === 0 && dayData.logs.length === 0) {
                    content = `
                        <div class="empty-state">
                            <i class="fas fa-calendar-times"></i>
                            <p>è¿™ä¸€å¤©æ²¡æœ‰ä»»åŠ¡æˆ–æ—¥å¿—</p>
                        </div>
                    `;
                }
                
                modalBody.innerHTML = content;
                
            } catch (error) {
                console.error('åŠ è½½è¯¦æƒ…å¤±è´¥:', error);
                modalBody.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</p>
                    </div>
                `;
            }
        }
        
        // æ¸²æŸ“ä»»åŠ¡è¯¦æƒ…å¡ç‰‡
        function renderTaskDetail(task) {
            const priorityMap = { 'high': 'é«˜', 'medium': 'ä¸­', 'low': 'ä½' };
            const statusMap = { 'pending': 'å¾…å¤„ç†', 'in_progress': 'è¿›è¡Œä¸­', 'completed': 'å·²å®Œæˆ', 'cancelled': 'å·²å–æ¶ˆ' };
            const priority = priorityMap[task.priority] || 'æœªè®¾ç½®';
            const status = statusMap[task.status] || 'æœªçŸ¥';
            const progress = task.progress || 0;
            
            return `
                <div class="detail-card">
                    <div class="detail-card-header">
                        <div class="detail-title">${task.title || task.name || 'æœªå‘½åä»»åŠ¡'}</div>
                        <div class="detail-badges">
                            <span class="badge priority-${task.priority || 'low'}">${priority}</span>
                            <span class="badge status">${status}</span>
                        </div>
                    </div>
                    
                    <div class="detail-info">
                        ${task.assignee_name ? `
                            <div class="info-item">
                                <i class="fas fa-user"></i>
                                <span>è´Ÿè´£äºº: ${task.assignee_name}</span>
                            </div>
                        ` : ''}
                        ${task.dueAt || task.due_at ? `
                            <div class="info-item">
                                <i class="fas fa-calendar-alt"></i>
                                <span>æˆªæ­¢: ${formatDate(task.dueAt || task.due_at)}</span>
                            </div>
                        ` : ''}
                        ${task.createdAt || task.created_at ? `
                            <div class="info-item">
                                <i class="fas fa-clock"></i>
                                <span>åˆ›å»º: ${formatDate(task.createdAt || task.created_at)}</span>
                            </div>
                        ` : ''}
                        ${task.updatedAt || task.updated_at ? `
                            <div class="info-item">
                                <i class="fas fa-edit"></i>
                                <span>æ›´æ–°: ${formatDate(task.updatedAt || task.updated_at)}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${task.description ? `
                        <div class="detail-description">
                            <strong>æè¿°:</strong> ${task.description}
                        </div>
                    ` : ''}
                    
                    <div class="progress-section">
                        <div class="progress-label">è¿›åº¦: ${progress}%</div>
                        <div class="progress-bar-wrapper">
                            <div class="progress-bar-inner" style="width: ${progress}%"></div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // æ¸²æŸ“æ—¥å¿—è¯¦æƒ…å¡ç‰‡
        function renderLogDetail(log) {
            return `
                <div class="log-card">
                    <div class="log-title">${log.title || 'æœªå‘½åæ—¥å¿—'}</div>
                    <div class="log-meta">
                        ${log.authorName ? `<span><i class="fas fa-user"></i> ${log.authorName}</span> ` : ''}
                        ${log.createdAt || log.created_at ? `<span><i class="fas fa-clock"></i> ${formatDate(log.createdAt || log.created_at)}</span>` : ''}
                    </div>
                    ${log.content ? `<div style="margin-top: 8px; color: #558b2f;">${log.content}</div>` : ''}
                </div>
            `;
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeDayModal() {
            document.getElementById('dayModal').style.display = 'none';
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('dayModal');
            if (event.target === modal) {
                closeDayModal();
            }
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateStr) {
            if (!dateStr) return 'æœªçŸ¥';
            const date = new Date(dateStr);
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const h = String(date.getHours()).padStart(2, '0');
            const min = String(date.getMinutes()).padStart(2, '0');
            return `${y}-${m}-${d} ${h}:${min}`;
        }
        
        // ä¸Šä¸€ä¸ªæœˆ
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }
        
        // ä¸‹ä¸€ä¸ªæœˆ
        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }
        
        // æ¸²æŸ“ç»Ÿè®¡æ•°æ®
        function renderStats() {
            // ä»»åŠ¡ç»Ÿè®¡
            const totalTasks = allTasks.length;
            const completedTasks = allTasks.filter(t => (t.progress || 0) >= 100).length;
            const inProgressTasks = allTasks.filter(t => {
                const p = t.progress || 0;
                return p > 0 && p < 100;
            }).length;
            const pendingTasks = allTasks.filter(t => (t.progress || 0) === 0).length;
            
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('completedTasks').textContent = completedTasks;
            document.getElementById('inProgressTasks').textContent = inProgressTasks;
            document.getElementById('pendingTasks').textContent = pendingTasks;
            document.getElementById('totalLogs').textContent = allLogs.length;
            document.getElementById('totalUsers').textContent = allUsers.length;
        }
        
        // æ¸²æŸ“ä»Šæ—¥æ¦‚è§ˆ
        function renderTodaySummary() {
            const today = new Date().toISOString().split('T')[0];
            const todayData = calendarData[today] || { tasks: [], logs: [] };
            
            document.getElementById('todayTasks').textContent = todayData.tasks.length;
            document.getElementById('todayLogs').textContent = todayData.logs.length;
            
            // è®¡ç®—å³å°†åˆ°æœŸçš„ä»»åŠ¡ï¼ˆ7å¤©å†…ï¼‰
            const upcoming = allTasks.filter(task => {
                const dueDate = task.dueAt || task.due_at;
                if (!dueDate) return false;
                const due = new Date(dueDate);
                const now = new Date();
                const diff = (due - now) / (1000 * 60 * 60 * 24);
                return diff >= 0 && diff <= 7;
            }).length;
            
            document.getElementById('upcomingDeadlines').textContent = upcoming;
        }
        
        // æ¸²æŸ“è¿‘æœŸä»»åŠ¡
        function renderRecentTasks() {
            const container = document.getElementById('recentTasksList');
            
            if (allTasks.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #7a5a33; padding: 20px;">æš‚æ— ä»»åŠ¡</div>';
                return;
            }
            
            // æŒ‰æ›´æ–°æ—¶é—´æ’åºï¼Œå–æœ€è¿‘5ä¸ª
            const recentTasks = [...allTasks]
                .sort((a, b) => {
                    const dateA = new Date(a.updatedAt || a.updated_at || a.createdAt || a.created_at || 0);
                    const dateB = new Date(b.updatedAt || b.updated_at || b.createdAt || b.created_at || 0);
                    return dateB - dateA;
                })
                .slice(0, 5);
            
            container.innerHTML = recentTasks.map(task => {
                const priority = task.priority || 'low';
                const priorityText = { high: 'é«˜', medium: 'ä¸­', low: 'ä½' }[priority] || 'ä½';
                const progress = task.progress || 0;
                
                return `
                <div class="task-item">
                        <div class="task-header">
                            <div class="task-title">${task.title || task.name || 'æœªå‘½åä»»åŠ¡'}</div>
                            <div class="task-priority ${priority}">${priorityText}</div>
                        </div>
                        <div class="task-meta">
                            è¿›åº¦: ${progress}%
                            ${task.dueAt || task.due_at ? ` | æˆªæ­¢: ${formatDate(task.dueAt || task.due_at)}` : ''}
                        </div>
                        <div class="task-progress-bar">
                            <div class="task-progress-fill" style="width: ${progress}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸæ˜¾ç¤º
        function formatDate(dateStr) {
            if (!dateStr) return 'æœªè®¾å®š';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return 'æœªè®¾å®š';
            return `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
        }
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initCharts() {
            // ä»»åŠ¡çŠ¶æ€åˆ†å¸ƒé¥¼å›¾
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            pieChart = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: ['å·²å®Œæˆ', 'è¿›è¡Œä¸­', 'å¾…å¼€å§‹'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#4CAF50', '#FF9800', '#F44336'],
                        borderColor: ['#fff', '#fff', '#fff'],
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 13 }
                            }
                        }
                    }
                }
            });

            // ä¼˜å…ˆçº§åˆ†å¸ƒé¥¼å›¾
            const priorityCtx = document.getElementById('priorityChart').getContext('2d');
            priorityChart = new Chart(priorityCtx, {
                type: 'doughnut',
                data: {
                    labels: ['é«˜ä¼˜å…ˆçº§', 'ä¸­ä¼˜å…ˆçº§', 'ä½ä¼˜å…ˆçº§'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#F44336', '#FF9800', '#4CAF50'],
                        borderColor: ['#fff', '#fff', '#fff'],
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 13 }
                            }
                        }
                    }
                }
            });

            // è¶‹åŠ¿æŠ˜çº¿å›¾
            const trendCtx = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'ä»»åŠ¡æ•°',
                        data: [],
                        borderColor: '#FF8A00',
                        backgroundColor: 'rgba(255, 138, 0, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'æ—¥å¿—æ•°',
                        data: [],
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 13 }
                            }
                        }
                    }
                }
            });
        }

        // æ›´æ–°å›¾è¡¨æ•°æ®
        function updateCharts() {
            // æ›´æ–°çŠ¶æ€åˆ†å¸ƒé¥¼å›¾
            const completed = allTasks.filter(t => (t.progress || 0) >= 100).length;
            const inProgress = allTasks.filter(t => {
                const p = t.progress || 0;
                return p > 0 && p < 100;
            }).length;
            const pending = allTasks.filter(t => (t.progress || 0) === 0).length;
            
            pieChart.data.datasets[0].data = [completed, inProgress, pending];
            pieChart.update();

            // æ›´æ–°ä¼˜å…ˆçº§åˆ†å¸ƒé¥¼å›¾
            const highPriority = allTasks.filter(t => t.priority === 'high').length;
            const mediumPriority = allTasks.filter(t => t.priority === 'medium').length;
            const lowPriority = allTasks.filter(t => !t.priority || t.priority === 'low').length;
            
            priorityChart.data.datasets[0].data = [highPriority, mediumPriority, lowPriority];
            priorityChart.update();
            
            // æ›´æ–°è¶‹åŠ¿å›¾ï¼ˆæœ€è¿‘30å¤©ï¼‰
            const now = new Date();
            const labels = [];
            const taskData = [];
            const logData = [];
            
            for (let i = 29; i >= 0; i--) {
                const date = new Date(now);
                date.setDate(date.getDate() - i);
                const dateStr = date.toISOString().split('T')[0];
                
                labels.push(`${date.getMonth() + 1}/${date.getDate()}`);
                
                const dayData = calendarData[dateStr] || { tasks: [], logs: [] };
                taskData.push(dayData.tasks.length);
                logData.push(dayData.logs.length);
            }
            
            trendChart.data.labels = labels;
            trendChart.data.datasets[0].data = taskData;
            trendChart.data.datasets[1].data = logData;
            trendChart.update();
        }
        
        // åŠ è½½å…¬å¸é‡è¦äº‹é¡¹
        async function loadImportantTasks() {
            try {
                const tasks = await window.API.getImportantTasks();
                const container = document.getElementById('importantTasksList');
                
                if (!tasks || tasks.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #7a5a33; padding: 20px;">æš‚æ— é‡è¦äº‹é¡¹</div>';
                    return;
                }
                
                container.innerHTML = tasks.map(task => `
                    <div class="important-item">
                        <i class="fas fa-check-circle"></i>
                        <span>${task}</span>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('åŠ è½½å…¬å¸é‡è¦äº‹é¡¹å¤±è´¥:', error);
                document.getElementById('importantTasksList').innerHTML = 
                    '<div style="text-align: center; color: #999; padding: 20px;">åŠ è½½å¤±è´¥</div>';
            }
        }
    </script>
</body>
</html>
