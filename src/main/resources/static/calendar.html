<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>统计周报 - 潘多拉工作日志管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/theme.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { align-items: flex-start; background: linear-gradient(135deg, #fff7ef 0%, #ffe9d2 100%); }
        .layout { width: 100%; max-width: 1400px; margin: 32px auto; padding: 0 40px; }
        .topbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
        .brand { display: flex; align-items: center; gap: 12px; }
        .brand .logo { width: 48px; height: 48px; margin: 0; }
        .brand strong { font-size: 22px; font-family: 'ZCOOL KuaiLe', 'Noto Sans SC', sans-serif; color: #a55b00; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, var(--color-peach), var(--color-primary-2)); border: 2px solid #fff; box-shadow: 0 3px 10px rgba(255,138,0,0.25); }
        .panel { background: #fff; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .nav-links { display:flex; gap:10px; flex-wrap:wrap; }
        .nav-links a { padding:8px 14px; border-radius:10px; background:#fff7ef; border:1px solid #ffd3a1; color:#a55b00; text-decoration:none; font-weight:500; transition: all 0.3s; }
        .nav-links a:hover { background:#ffbe78; color:#fff; transform: translateY(-2px); }
        .panel h3 { margin: 0 0 20px 0; color: #a55b00; font-family: 'ZCOOL KuaiLe', 'Noto Sans SC', sans-serif; font-size: 24px; border-bottom: 3px solid #ffd3a1; padding-bottom: 12px; }
        
        /* 公司重要事项 */
        .important-tasks {
            background: linear-gradient(135deg, #fff7ef 0%, #ffe8cf 100%);
            border: 2px solid #ffbe78;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 12px rgba(255,138,0,0.1);
            position: relative;
            overflow: hidden;
        }
        .important-tasks::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff8a00 0%, #ffbe78 50%, #ff8a00 100%);
            background-size: 200% 100%;
            animation: shimmer 3s infinite;
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .important-tasks h4 {
            color: #ff8a00;
            margin: 0 0 20px 0;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(255,138,0,0.1);
        }
        .important-tasks h4 i {
            font-size: 22px;
            background: linear-gradient(135deg, #ff8a00 0%, #ffbe78 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .important-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 16px;
        }
        .important-item {
            background: #fff;
            border: 1px solid #ffd3a1;
            border-radius: 12px;
            padding: 16px;
            font-size: 14px;
            color: #7a5a33;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(255,138,0,0.08);
            position: relative;
            overflow: hidden;
        }
        .important-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #ff8a00 0%, #ffbe78 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }
        .important-item:hover {
            border-color: #ff8a00;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(255,138,0,0.1);
        }
        .important-item:hover::before {
            opacity: 1;
        }
        .important-item i {
            color: #ff8a00;
            font-size: 16px;
            flex-shrink: 0;
        }
        .important-item span {
            line-height: 1.4;
            word-break: break-word;
        }
        
        /* 统计卡片 */
        .stats-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 16px; margin-bottom: 24px; }
        @media (max-width: 1400px) { .stats-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 900px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .stats-grid { grid-template-columns: 1fr; } }
        .stat-card { background: linear-gradient(135deg, var(--color-cream) 0%, var(--color-peach) 100%); border-radius: 12px; padding: 20px; text-align: center; border: 2px solid #ffd3a1; transition: all 0.3s; }
        .stat-card:hover { transform: translateY(-2px); box-shadow: 0 3px 8px rgba(255,138,0,0.15); }
        .stat-number { font-size: 36px; font-weight: 700; color: var(--color-primary); margin-bottom: 8px; }
        .stat-label { font-size: 14px; color: #7a5a33; font-weight: 500; }
        .stat-icon { font-size: 24px; margin-bottom: 8px; }
        
        /* 日历样式 */
        .calendar-section { display: grid; grid-template-columns: 1fr 350px; gap: 24px; }
        @media (max-width: 1100px) { .calendar-section { grid-template-columns: 1fr; } }
        .calendar {
            background: #fff;
            border-radius: 16px;
            padding: 24px;
            border: 2px solid #ffd3a1;
            box-shadow: 0 4px 12px rgba(255,138,0,0.08);
            position: relative;
            overflow: hidden;
        }
        .calendar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #ff8a00 0%, #ffbe78 50%, #ff8a00 100%);
            background-size: 200% 100%;
            animation: shimmer 3s infinite;
        }
        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 1px solid #ffd3a1;
        }
        .calendar-header h4 {
            color: #a55b00;
            margin: 0;
            font-size: 20px;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(165,91,0,0.1);
        }
        .calendar-header button {
            background: #fff;
            border: 1px solid #ffd3a1;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s;
            color: #a55b00;
            font-weight: 500;
        }
        .calendar-header button:hover {
            background: #ffbe78;
            color: #fff;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(255,138,0,0.1);
        }
        .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-bottom: 12px; }
        .weekday {
            text-align: center;
            padding: 12px 8px;
            font-weight: 600;
            color: #ff8a00;
            font-size: 14px;
            background: linear-gradient(135deg, #fff7ef 0%, #ffe9d2 100%);
            border-radius: 8px;
            border: 1px solid #ffd3a1;
        }
        .calendar-days { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .day-cell {
            background: #fff7ef;
            border: 1px solid #ffd3a1;
            min-height: 90px;
            border-radius: 10px;
            padding: 8px;
            font-size: 13px;
            color: #7a5a33;
            position: relative;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(255,138,0,0.05);
        }
        .day-cell:hover {
            background: #ffe9d2;
            border-color: #ff8a00;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(255,138,0,0.15);
        }
        .day-cell.today {
            background: linear-gradient(135deg, #ffe8cf 0%, #ffd3a1 100%);
            border: 2px solid #ff8a00;
            font-weight: 700;
            box-shadow: 0 4px 8px rgba(255,138,0,0.2);
        }
        .day-cell.other-month {
            background: #f5f5f5;
            color: #ccc;
            opacity: 0.6;
        }
        .day-number {
            font-weight: 600;
            margin-bottom: 6px;
            font-size: 14px;
        }
        .day-indicators {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }
        .indicator {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .indicator.task {
            background: linear-gradient(135deg, #ff8a00 0%, #ffbe78 100%);
        }
        .indicator.log {
            background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
        }
        .indicator.deadline {
            background: linear-gradient(135deg, #F44336 0%, #EF5350 100%);
        }
        
        /* 侧边栏 */
        .sidebar-section { background: #fff; border-radius: 14px; padding: 20px; border: 2px solid #ffd3a1; }
        .sidebar-section h4 { color: #a55b00; margin: 0 0 16px 0; font-size: 16px; border-bottom: 2px solid #ffd3a1; padding-bottom: 8px; }
        .today-summary { margin-bottom: 16px; }
        .summary-item { display: flex; justify-content: space-between; padding: 10px; background: #fff7ef; border-radius: 8px; margin-bottom: 8px; }
        .summary-label { color: #7a5a33; font-size: 13px; }
        .summary-value { color: #ff8a00; font-weight: 600; font-size: 14px; }
        
        /* 图表 */
        .charts-section { margin-top: 24px; }
        .charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
        @media (max-width: 900px) { .charts-grid { grid-template-columns: 1fr; } }
        .chart-container { background: #fff; border: 2px solid #ffd3a1; border-radius: 14px; padding: 20px; }
        .chart-title { color: #a55b00; font-weight: 600; margin-bottom: 16px; text-align: center; font-size: 16px; }
        .chart-canvas { position: relative; height: 280px; }
        
        /* 任务列表 */
        .task-list { max-height: 400px; overflow-y: auto; }
        .task-item { background: #fff7ef; border: 1px solid #ffd3a1; border-radius: 8px; padding: 12px; margin-bottom: 8px; transition: all 0.3s; }
        .task-item:hover { background: #ffe9d2; border-color: #ff8a00; transform: translateX(4px); }
        .task-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .task-title { font-weight: 600; color: #333; font-size: 14px; }
        .task-priority { padding: 2px 8px; border-radius: 4px; font-size: 11px; }
        .task-priority.high { background: #ffebee; color: #c62828; }
        .task-priority.medium { background: #fff3e0; color: #e65100; }
        .task-priority.low { background: #e8f5e9; color: #2e7d32; }
        .task-meta { font-size: 12px; color: #7a5a33; }
        .task-progress-bar { height: 6px; background: #ffd3a1; border-radius: 3px; overflow: hidden; margin-top: 6px; }
        .task-progress-fill { height: 100%; background: linear-gradient(90deg, #ff8a00 0%, #ffbe78 100%); transition: width 0.3s; }
        
        /* 加载状态 */
        .loading { text-align: center; padding: 40px; color: #7a5a33; }
        .loading i { font-size: 32px; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* 日期详情模态框 */
        .day-modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); overflow: auto; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .day-modal-content { background: #fff; margin: 5% auto; padding: 0; border-radius: 16px; max-width: 800px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); animation: slideDown 0.3s; }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .day-modal-header { background: linear-gradient(135deg, #ff8a00 0%, #ff6b00 100%); color: white; padding: 24px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center; }
        .day-modal-header h2 { margin: 0; font-family: 'ZCOOL KuaiLe', 'Noto Sans SC', sans-serif; font-size: 22px; }
        .day-modal-close { background: transparent; border: none; color: white; font-size: 28px; cursor: pointer; padding: 0; width: 32px; height: 32px; line-height: 28px; border-radius: 50%; transition: all 0.3s; }
        .day-modal-close:hover { background: rgba(255,255,255,0.2); transform: rotate(45deg); }
        .day-modal-body { padding: 24px; max-height: 70vh; overflow-y: auto; }
        .day-section { margin-bottom: 24px; }
        .day-section-title { color: #a55b00; font-size: 18px; font-weight: 600; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid #ffd3a1; display: flex; align-items: center; gap: 8px; }
        .detail-card { background: linear-gradient(135deg, #fff7ef 0%, #ffe9d2 100%); border: 2px solid #ffd3a1; border-radius: 12px; padding: 16px; margin-bottom: 12px; transition: all 0.3s; }
        .detail-card:hover { border-color: #ff8a00; box-shadow: 0 2px 6px rgba(255,138,0,0.1); transform: translateX(2px); }
        .detail-card-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px; }
        .detail-title { font-size: 16px; font-weight: 600; color: #333; flex: 1; }
        .detail-badges { display: flex; gap: 8px; align-items: center; }
        .badge { padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 500; }
        .badge.priority-high { background: #ffebee; color: #c62828; }
        .badge.priority-medium { background: #fff3e0; color: #e65100; }
        .badge.priority-low { background: #e8f5e9; color: #2e7d32; }
        .badge.status { background: #e3f2fd; color: #1565c0; }
        .detail-info { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 12px; }
        .info-item { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #7a5a33; }
        .info-item i { color: #ff8a00; width: 16px; }
        .detail-description { margin-top: 12px; padding-top: 12px; border-top: 1px dashed #ffd3a1; color: #555; font-size: 14px; line-height: 1.6; }
        .progress-section { margin-top: 12px; }
        .progress-label { font-size: 12px; color: #7a5a33; margin-bottom: 4px; }
        .progress-bar-wrapper { height: 8px; background: #ffd3a1; border-radius: 4px; overflow: hidden; }
        .progress-bar-inner { height: 100%; background: linear-gradient(90deg, #ff8a00 0%, #ffbe78 100%); transition: width 0.3s; }
        .log-card { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border: 2px solid #81c784; border-radius: 12px; padding: 16px; margin-bottom: 12px; }
        .log-card:hover { border-color: #4caf50; box-shadow: 0 2px 6px rgba(76,175,80,0.1); }
        .log-title { font-size: 16px; font-weight: 600; color: #2e7d32; margin-bottom: 8px; }
        .log-meta { font-size: 13px; color: #558b2f; }
        .empty-state { text-align: center; padding: 40px; color: #999; }
        .empty-state i { font-size: 48px; margin-bottom: 16px; opacity: 0.5; }
        
        /* 登录趋势统计样式 */
        .trend-query-form {
            background: linear-gradient(135deg, #fff7ef 0%, #ffe9d2 100%);
            border: 2px solid #ffd3a1;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
        }
        .trend-query-row {
            display: flex;
            gap: 16px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        .trend-query-item {
            flex: 1;
            min-width: 180px;
        }
        .trend-query-label {
            display: block;
            font-size: 14px;
            color: #7a5a33;
            font-weight: 500;
            margin-bottom: 8px;
        }
        .trend-query-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #ffd3a1;
            border-radius: 10px;
            font-size: 14px;
            background: #fff;
            transition: all 0.3s;
            outline: none;
        }
        .trend-query-input:focus {
            border-color: #ff8a00;
            box-shadow: 0 0 0 4px rgba(255,138,0,0.15);
        }
        .trend-query-btn {
            padding: 12px 32px;
            background: linear-gradient(135deg, #ff8a00 0%, #ff6b00 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(255,138,0,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .trend-query-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255,138,0,0.3);
        }
        .trend-query-btn:active {
            transform: translateY(0);
        }
        .trend-query-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .trend-info { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; }
        .trend-info-item { flex: 1; min-width: 200px; background: linear-gradient(135deg, #fff7ef 0%, #ffe9d2 100%); border: 2px solid #ffd3a1; border-radius: 12px; padding: 16px; text-align: center; }
        .trend-info-label { font-size: 14px; color: #7a5a33; margin-bottom: 8px; }
        .trend-info-value { font-size: 20px; font-weight: 700; color: #ff8a00; }
        .trend-points { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }
        .trend-point-card { background: linear-gradient(135deg, #fff7ef 0%, #ffe9d2 100%); border: 2px solid #ffd3a1; border-radius: 12px; padding: 20px; transition: all 0.3s; }
        .trend-point-card:hover { border-color: #ff8a00; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(255,138,0,0.15); }
        .trend-point-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; padding-bottom: 12px; border-bottom: 1px dashed #ffd3a1; }
        .trend-point-title { font-size: 16px; font-weight: 600; color: #a55b00; }
        .trend-point-icon { font-size: 20px; color: #ff8a00; }
        .trend-point-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .trend-stat-item { background: #fff; border: 1px solid #ffd3a1; border-radius: 8px; padding: 12px; text-align: center; }
        .trend-stat-value { font-size: 24px; font-weight: 700; color: #ff8a00; margin-bottom: 4px; }
        .trend-stat-label { font-size: 12px; color: #7a5a33; }
    </style>
</head>
<body>
    <div class="layout">
        <div class="topbar">
            <div class="brand">
                <div class="logo" style="width: 48px; height: 48px; background: linear-gradient(135deg, #ff8a00 0%, #ffb06b 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(255, 138, 0, 0.3); overflow: hidden; padding: 4px;">
                    <img src="data/picture/LOGO.png" alt="Logo" style="width: 100%; height: 100%; object-fit: contain;">
                </div>
                <strong>工作日程表</strong>
            </div>
            <div style="display:flex; align-items:center; gap:16px;">
                <nav class="nav-links">
                    <a href="publish.html"><i class="fas fa-plus-circle"></i> 发布任务</a>
                    <a href="dashboard.html"><i class="fas fa-book"></i> 工作日志</a>
                    <a href="users.html"><i class="fas fa-users"></i> 用户管理</a>
                    <a href="tasks.html"><i class="fas fa-tasks"></i> 任务展示</a>
                    <a href="profile.html"><i class="fas fa-user"></i> 个人信息</a>
                </nav>
                <div class="profile" onclick="location.href='profile.html'" style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                <span id="currentUserName">用户</span>
                <div class="avatar"></div>
                </div>
            </div>
        </div>

        <!-- 公司重要事项 -->
        <div class="panel">
            <div class="important-tasks">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h4 style="margin: 0;"><i class="fas fa-star"></i> 公司十大重要事项</h4>
                    <button id="editImportantTasksBtn" class="btn-edit" style="padding: 8px 16px; background: linear-gradient(135deg, #ff8a00 0%, #ff6b00 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; transition: all 0.3s; display: flex; align-items: center; gap: 6px;"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(255,138,0,0.3)'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <i class="fas fa-edit"></i> 编辑
                    </button>
                </div>
                <div id="importantTasksList" class="important-list">
                    <div class="loading"><i class="fas fa-spinner"></i> 加载中...</div>
                </div>
            </div>
        </div>

        <!-- 统计数据 -->
        <div class="panel">
            <h3><i class="fas fa-chart-bar"></i> 数据统计概览</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-tasks"></i></div>
                    <div class="stat-number" id="totalTasks">0</div>
                    <div class="stat-label">总任务数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="stat-number" id="completedTasks">0</div>
                    <div class="stat-label">已完成任务</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-spinner"></i></div>
                    <div class="stat-number" id="inProgressTasks">0</div>
                    <div class="stat-label">进行中任务</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-clock"></i></div>
                    <div class="stat-number" id="pendingTasks">0</div>
                    <div class="stat-label">待开始任务</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-book-open"></i></div>
                    <div class="stat-number" id="totalLogs">0</div>
                    <div class="stat-label">工作日志数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-users"></i></div>
                    <div class="stat-number" id="totalUsers">0</div>
                    <div class="stat-label">团队成员数</div>
                </div>
                </div>
            </div>
            
            <!-- 用户信息统计模块 -->
            <div class="panel">
                <h3><i class="fas fa-users-cog"></i> 用户信息统计</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-user-tie"></i></div>
                        <div class="stat-number" id="activeUsers">0</div>
                        <div class="stat-label">活跃用户</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-user-shield"></i></div>
                        <div class="stat-number" id="adminUsers">0</div>
                        <div class="stat-label">管理员</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-user-cog"></i></div>
                        <div class="stat-number" id="managerUsers">0</div>
                        <div class="stat-label">项目经理</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-user-friends"></i></div>
                        <div class="stat-number" id="teamLeaderUsers">0</div>
                        <div class="stat-label">团队领导</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-user"></i></div>
                        <div class="stat-number" id="memberUsers">0</div>
                        <div class="stat-label">普通成员</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon"><i class="fas fa-user-slash"></i></div>
                        <div class="stat-number" id="inactiveUsers">0</div>
                        <div class="stat-label">非活跃用户</div>
                    </div>
                </div>
                
            </div>
            
        <!-- 日历和侧边栏 -->
        <div class="calendar-section">
            <div class="calendar">
                <div class="calendar-header">
                    <h4 id="calendarTitle">本月日程</h4>
                    <div>
                        <button onclick="previousMonth()" style="padding:6px 12px; border:1px solid #ffd3a1; background:#fff; border-radius:6px; cursor:pointer; margin-right:8px;"><i class="fas fa-chevron-left"></i></button>
                        <button onclick="nextMonth()" style="padding:6px 12px; border:1px solid #ffd3a1; background:#fff; border-radius:6px; cursor:pointer;"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <div class="calendar-weekdays">
                    <div class="weekday">周日</div>
                    <div class="weekday">周一</div>
                    <div class="weekday">周二</div>
                    <div class="weekday">周三</div>
                    <div class="weekday">周四</div>
                    <div class="weekday">周五</div>
                    <div class="weekday">周六</div>
                </div>
                <div id="calendarGrid" class="calendar-days"></div>
            </div>
            
            <div class="sidebar-section">
                <h4><i class="fas fa-calendar-day"></i> 今日概览</h4>
                <div class="today-summary">
                    <div class="summary-item">
                        <span class="summary-label">今日任务</span>
                        <span class="summary-value" id="todayTasks">0</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-label">今日日志</span>
                        <span class="summary-value" id="todayLogs">0</span>
                        </div>
                    <div class="summary-item">
                        <span class="summary-label">即将到期</span>
                        <span class="summary-value" id="upcomingDeadlines">0</span>
                    </div>
                </div>
                <h4 style="margin-top:20px;"><i class="fas fa-fire"></i> 近期任务</h4>
                <div id="recentTasksList" class="task-list">
                    <div class="loading"><i class="fas fa-spinner"></i> 加载中...</div>
                </div>
            </div>
        </div>

        <!-- 图表统计 -->
        <div class="panel charts-section">
            <h3><i class="fas fa-chart-pie"></i> 用户数据可视化分析</h3>
                <div class="charts-grid">
                    <div class="chart-container">
                    <div class="chart-title">用户角色分布</div>
                        <div class="chart-canvas">
                            <canvas id="userRoleChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                    <div class="chart-title">用户性别分布</div>
                        <div class="chart-canvas">
                        <canvas id="userGenderChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                <div class="chart-title">用户状态分布</div>
                <div class="chart-canvas" style="height: 300px;">
                    <canvas id="userStatusChart"></canvas>
                    </div>
                </div>
                
                <!-- 登录趋势统计 -->
                <div style="margin-top: 24px;">
                    <h3 style="margin: 0 0 20px 0; color: #a55b00; font-family: 'ZCOOL KuaiLe', 'Noto Sans SC', sans-serif; font-size: 24px; border-bottom: 3px solid #ffd3a1; padding-bottom: 12px;">
                        <i class="fas fa-chart-line"></i> 登录趋势统计
                    </h3>
                    
                    <!-- 查询表单 -->
                    <div class="trend-query-form">
                        <div class="trend-query-row">
                            <div class="trend-query-item">
                                <label class="trend-query-label">统计周期</label>
                                <select id="trendTimeUnit" class="trend-query-input">
                                    <option value="day">按日</option>
                                    <option value="week" selected>按周</option>
                                    <option value="month">按月</option>
                                </select>
                            </div>
                            <div class="trend-query-item">
                                <label class="trend-query-label">开始日期</label>
                                <input type="date" id="trendStartDate" class="trend-query-input" value="2025-11-01">
                            </div>
                            <div class="trend-query-item">
                                <label class="trend-query-label">结束日期</label>
                                <input type="date" id="trendEndDate" class="trend-query-input" value="2025-12-31">
                            </div>
                            <button id="trendQueryBtn" class="trend-query-btn" onclick="queryLoginTrend()">
                                <i class="fas fa-search"></i> 查询
                            </button>
                        </div>
                    </div>
                    
                    <div id="loginTrendContainer">
                        <div class="loading"><i class="fas fa-spinner"></i> 加载中...</div>
                    </div>
                </div>

                <!-- 密码重置统计 -->
                <div style="margin-top: 24px;">
                    <h3 style="margin: 0 0 20px 0; color: #a55b00; font-family: 'ZCOOL KuaiLe', 'Noto Sans SC', sans-serif; font-size: 24px; border-bottom: 3px solid #ffd3a1; padding-bottom: 12px;">
                        <i class="fas fa-key"></i> 密码重置统计
                    </h3>
                    
                    <div id="resetPasswordContainer">
                        <div class="loading"><i class="fas fa-spinner"></i> 加载中...</div>
                    </div>
                </div>

                <!-- 任务统计 -->
                <div style="margin-top: 24px;">
                    <h3 style="margin: 0 0 20px 0; color: #a55b00; font-family: 'ZCOOL KuaiLe', 'Noto Sans SC', sans-serif; font-size: 24px; border-bottom: 3px solid #ffd3a1; padding-bottom: 12px;">
                        <i class="fas fa-chart-bar"></i> 任务统计
                    </h3>
                    
                    <!-- 查询表单 -->
                    <div class="trend-query-form">
                        <div class="trend-query-row">
                            <div class="trend-query-item">
                                <label class="trend-query-label">开始日期</label>
                                <input type="date" id="taskStartDate" class="trend-query-input">
                            </div>
                            <div class="trend-query-item">
                                <label class="trend-query-label">结束日期</label>
                                <input type="date" id="taskEndDate" class="trend-query-input">
                            </div>
                            <button id="taskQueryBtn" class="trend-query-btn" onclick="queryTaskStatistic()">
                                <i class="fas fa-search"></i> 查询
                            </button>
                        </div>
                    </div>
                    
                    <div id="taskStatisticContainer">
                        <div class="loading"><i class="fas fa-spinner"></i> 加载中...</div>
                    </div>
                </div>
            </div>
        </div>

    <!-- 日期详情模态框 -->
    <div id="dayModal" class="day-modal">
        <div class="day-modal-content">
            <div class="day-modal-header">
                <h2 id="modalDateTitle">2025-11-08</h2>
                <button class="day-modal-close" onclick="closeDayModal()">&times;</button>
            </div>
            <div class="day-modal-body" id="modalBody">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>加载中...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑公司重要事项模态框 -->
    <div id="editImportantTasksModal" class="day-modal">
        <div class="day-modal-content" style="max-width: 700px;">
            <div class="day-modal-header">
                <h2><i class="fas fa-edit"></i> 编辑公司十大重要事项</h2>
                <button class="day-modal-close" onclick="closeEditImportantTasksModal()">&times;</button>
            </div>
            <div class="day-modal-body">
                <div style="margin-bottom: 24px; padding: 16px; background: linear-gradient(135deg, #fff7ef 0%, #ffe9d2 100%); border-radius: 12px; border: 1px solid #ffd3a1; color: #7a5a33; font-size: 14px; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-info-circle" style="color: #ff8a00; font-size: 16px;"></i>
                    <span>请编辑以下十大重要事项，编号固定使用1到10：</span>
                </div>
                <div id="editTasksContainer">
                    <!-- 任务编辑项将通过JavaScript动态生成 -->
                </div>
                <div style="margin-top: 32px; display: flex; justify-content: flex-end; gap: 16px; padding-top: 20px; border-top: 1px dashed #ffd3a1;">
                    <button onclick="closeEditImportantTasksModal()" style="padding: 12px 24px; border: 2px solid #ffd3a1; background: #fff; color: #a55b00; border-radius: 10px; cursor: pointer; font-weight: 500; transition: all 0.3s; display: flex; align-items: center; gap: 8px;"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(255,138,0,0.15)'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <i class="fas fa-times"></i> 取消
                    </button>
                    <button onclick="saveImportantTasks()" style="padding: 12px 24px; background: linear-gradient(135deg, #ff8a00 0%, #ff6b00 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 500; transition: all 0.3s; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 12px rgba(255,138,0,0.2);"
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(255,138,0,0.3)'"
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(255,138,0,0.2)'">
                        <i class="fas fa-save"></i> 保存
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script src="js/api.js"></script>
    <script>
        // 设置用户名
        try { const raw=localStorage.getItem('currentUser'); const u=raw?JSON.parse(raw):{name:'用户'}; document.getElementById('currentUserName').textContent=u.name||'用户'; } catch(e){}
        
        // 全局数据存储
        let allTasks = [];
        let allLogs = [];
        let allUsers = [];
        let currentDate = new Date();
        let calendarData = {}; // 日期 -> {tasks, logs}
        
        // 图表实例
        let userRoleChart, userGenderChart, userStatusChart;
        
        // 初始化
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('统计周报页面加载...');
            await loadAllData();
            initCharts();
            renderCalendar();
            renderStats();
            renderTodaySummary();
            renderRecentTasks();
            updateCharts();
            loadImportantTasks();
            
            // 加载用户统计数据
            await loadUserStats();
             
            // 添加编辑按钮事件监听
            document.getElementById('editImportantTasksBtn').addEventListener('click', openEditImportantTasksModal);
            
            // 加载密码重置统计
            await loadResetPasswordStatistic();
            
            // 加载登录趋势统计（默认查询）
            await queryLoginTrend();
            
            // 检测任务统计接口是否有效
            await checkTaskStatisticApi();
            
            // 初始化任务统计日期范围（最近7天）
            initTaskStatisticDates();
            
            // 加载任务统计（默认查询）
            await queryTaskStatistic();
        });
        
        // 初始化任务统计日期范围
        function initTaskStatisticDates() {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setDate(startDate.getDate() - 6); // 7天前
            
            const startDateStr = startDate.toISOString().split('T')[0];
            const endDateStr = endDate.toISOString().split('T')[0];
            
            document.getElementById('taskStartDate').value = startDateStr;
            document.getElementById('taskEndDate').value = endDateStr;
        }
        
        // 查询任务统计数据
        async function queryTaskStatistic() {
            console.log('========================================');
            console.log('开始查询任务统计数据...');
            console.log('========================================');
            
            const container = document.getElementById('taskStatisticContainer');
            const queryBtn = document.getElementById('taskQueryBtn');
            
            // 获取查询参数
            const startDate = document.getElementById('taskStartDate').value;
            const endDate = document.getElementById('taskEndDate').value;
            
            // 验证参数
            if (!startDate || !endDate) {
                alert('请选择开始日期和结束日期');
                return;
            }
            
            if (new Date(startDate) > new Date(endDate)) {
                alert('开始日期不能晚于结束日期');
                return;
            }
            
            // 显示加载状态
            container.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> 加载中...</div>';
            
            // 禁用查询按钮
            if (queryBtn) {
                queryBtn.disabled = true;
                queryBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 查询中...';
            }
            
            try {
                console.log('请求参数:', { startDate, endDate });
                console.log('请求URL:', window.APP.apiBase + '/api/tasks/statistic?startDate=' + startDate + '&endDate=' + endDate);
                
                const response = await window.API.getTaskStatistic(startDate, endDate);
                
                console.log('========================================');
                console.log('✅ 任务统计接口调用成功！');
                console.log('========================================');
                console.log('响应数据:', response);
                
                // 渲染数据到页面
                renderTaskStatistic(response);
                
                console.log('========================================');
                console.log('任务统计数据查询完成');
                console.log('========================================');
                
            } catch (error) {
                console.log('========================================');
                console.log('❌ 任务统计接口调用失败！');
                console.log('========================================');
                console.error('错误信息:', error.message);
                console.error('错误详情:', error);
                console.log('========================================');
                console.log('可能的原因:');
                console.log('1. 后端服务未启动或端口不正确');
                console.log('2. 接口路径不正确');
                console.log('3. 认证token无效或已过期');
                console.log('4. 网络连接问题');
                console.log('========================================');
                
                // 显示错误信息
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>查询失败: ${error.message}</p>
                    </div>
                `;
            } finally {
                // 恢复查询按钮
                if (queryBtn) {
                    queryBtn.disabled = false;
                    queryBtn.innerHTML = '<i class="fas fa-search"></i> 查询';
                }
            }
        }
        
        // 渲染任务统计
        function renderTaskStatistic(data) {
            const container = document.getElementById('taskStatisticContainer');
            
            if (!data || !data.daily || data.daily.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-chart-bar"></i>
                        <p>暂无任务统计数据</p>
                    </div>
                `;
                return;
            }
            
            // 渲染数据点
            let html = `
                <div class="trend-info" style="margin-bottom: 20px;">
                    <div class="trend-info-item">
                        <div class="trend-info-label">统计开始日期</div>
                        <div class="trend-info-value">${data.startDate || '未知'}</div>
                    </div>
                    <div class="trend-info-item">
                        <div class="trend-info-label">统计结束日期</div>
                        <div class="trend-info-value">${data.endDate || '未知'}</div>
                    </div>
                    <div class="trend-info-item">
                        <div class="trend-info-label">统计天数</div>
                        <div class="trend-info-value">${data.daily.length} 天</div>
                    </div>
                </div>
                
                <div class="trend-points">
            `;
            
            // 渲染每一天的数据
            data.daily.forEach((dayData, index) => {
                html += `
                    <div class="trend-point-card">
                        <div class="trend-point-header">
                            <div class="trend-point-title">${dayData.date || '未知日期'}</div>
                            <div class="trend-point-icon"><i class="fas fa-calendar-alt"></i></div>
                        </div>
                        <div class="trend-point-stats">
                            <div class="trend-stat-item">
                                <div class="trend-stat-value">${dayData.taskCreateCount || 0}</div>
                                <div class="trend-stat-label">创建任务数</div>
                            </div>
                            <div class="trend-stat-item">
                                <div class="trend-stat-value">${dayData.taskCreateUserCount || 0}</div>
                                <div class="trend-stat-label">创建任务用户</div>
                            </div>
                            <div class="trend-stat-item">
                                <div class="trend-stat-value">${dayData.reportCreateCount || 0}</div>
                                <div class="trend-stat-label">创建报告数</div>
                            </div>
                            <div class="trend-stat-item">
                                <div class="trend-stat-value">${dayData.reportCreateUserCount || 0}</div>
                                <div class="trend-stat-label">创建报告用户</div>
                            </div>
                            <div class="trend-stat-item">
                                <div class="trend-stat-value" style="color: #ff8a00;">${dayData.progressOver50Count || 0}</div>
                                <div class="trend-stat-label">进度>50%</div>
                            </div>
                            <div class="trend-stat-item">
                                <div class="trend-stat-value" style="color: #4CAF50;">${dayData.progressOver100Count || 0}</div>
                                <div class="trend-stat-label">进度>100%</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // 检测任务统计接口是否有效
        async function checkTaskStatisticApi() {
            console.log('========================================');
            console.log('开始检测任务统计接口是否有效...');
            console.log('========================================');
            
            try {
                // 使用默认日期范围：最近7天
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 6); // 7天前
                
                const startDateStr = startDate.toISOString().split('T')[0];
                const endDateStr = endDate.toISOString().split('T')[0];
                
                console.log('使用日期范围:', { startDate: startDateStr, endDate: endDateStr });
                
                // 调用任务统计接口
                const result = await window.API.getTaskStatistic(startDateStr, endDateStr);
                
                console.log('========================================');
                console.log('✅ 任务统计接口检测成功！');
                console.log('========================================');
                console.log('接口返回结果:', result);
                console.log('========================================');
                
                // 验证返回数据结构
                if (result && result.startDate && result.endDate && Array.isArray(result.daily)) {
                    console.log('✅ 数据结构验证通过');
                    console.log('- 统计开始日期:', result.startDate);
                    console.log('- 统计结束日期:', result.endDate);
                    console.log('- 每日数据条数:', result.daily.length);
                    
                    if (result.daily.length > 0) {
                        console.log('- 第一条数据示例:', result.daily[0]);
                    }
                } else {
                    console.warn('⚠ 数据结构验证失败，返回数据不符合预期格式');
                }
                
                console.log('========================================');
                console.log('任务统计接口检测完成，接口正常工作');
                console.log('========================================');
                
            } catch (error) {
                console.log('========================================');
                console.log('❌ 任务统计接口检测失败！');
                console.log('========================================');
                console.error('错误信息:', error.message);
                console.error('错误详情:', error);
                console.log('========================================');
                console.log('可能的原因:');
                console.log('1. 后端服务未启动或端口不正确');
                console.log('2. 接口路径不正确: /api/tasks/statistic');
                console.log('3. 认证token无效或已过期');
                console.log('4. 网络连接问题');
                console.log('5. 后端接口实现有问题');
                console.log('========================================');
            }
        }
        
        // 加载密码重置统计
        async function loadResetPasswordStatistic() {
            console.log('========================================');
            console.log('开始加载密码重置统计...');
            console.log('========================================');
            
            const container = document.getElementById('resetPasswordContainer');
            
            try {
                const result = await window.API.getResetPasswordStatistic();
                
                console.log('========================================');
                console.log('✅ 密码重置统计加载成功！');
                console.log('========================================');
                console.log('接口返回结果:', result);
                
                // 渲染数据
                renderResetPasswordStatistic(result);
                
                console.log('========================================');
                
            } catch (error) {
                console.log('========================================');
                console.log('❌ 密码重置统计加载失败！');
                console.log('========================================');
                console.error('错误信息:', error.message);
                console.log('========================================');
                
                // 显示错误信息
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>加载失败: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        // 渲染密码重置统计
        function renderResetPasswordStatistic(data) {
            const container = document.getElementById('resetPasswordContainer');
            
            if (!data || data.totalUsers === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-check-circle" style="color: #4CAF50;"></i>
                        <p>今日无异常用户</p>
                        <p style="font-size: 14px; color: #7a5a33; margin-top: 8px;">
                            统计日期: ${data.date || '未知'}<br>
                            阈值: ${data.threshold || 5} 次
                        </p>
                    </div>
                `;
                return;
            }
            
            // 有异常用户，渲染列表
            let html = `
                <div class="trend-info" style="margin-bottom: 20px;">
                    <div class="trend-info-item">
                        <div class="trend-info-label">统计日期</div>
                        <div class="trend-info-value">${data.date || '未知'}</div>
                    </div>
                    <div class="trend-info-item">
                        <div class="trend-info-label">阈值</div>
                        <div class="trend-info-value">${data.threshold || 5} 次</div>
                    </div>
                    <div class="trend-info-item">
                        <div class="trend-info-label">异常用户数</div>
                        <div class="trend-info-value" style="color: #F44336;">${data.totalUsers}</div>
                    </div>
                </div>
                
                <div class="trend-points">
            `;
            
            data.users.forEach((user, index) => {
                html += `
                    <div class="trend-point-card" style="border-color: #F44336;">
                        <div class="trend-point-header">
                            <div class="trend-point-title">${user.userName || '未知用户'}</div>
                            <div class="trend-point-icon" style="color: #F44336;"><i class="fas fa-exclamation-triangle"></i></div>
                        </div>
                        <div class="trend-point-stats">
                            <div class="trend-stat-item">
                                <div class="trend-stat-value" style="color: #F44336;">${user.resetCount || 0}</div>
                                <div class="trend-stat-label">重置次数</div>
                            </div>
                            <div class="trend-stat-item">
                                <div class="trend-stat-value">${user.userId || '未知'}</div>
                                <div class="trend-stat-label">用户ID</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        // 查询登录趋势统计数据
        async function queryLoginTrend() {
                console.log('========================================');
                console.log('开始查询登录趋势统计数据...');
                console.log('========================================');
                
                const container = document.getElementById('loginTrendContainer');
                const queryBtn = document.getElementById('trendQueryBtn');
                
                // 获取查询参数
                const timeUnit = document.getElementById('trendTimeUnit').value;
                const startDate = document.getElementById('trendStartDate').value;
                const endDate = document.getElementById('trendEndDate').value;
                
                // 验证参数
                if (!startDate || !endDate) {
                    alert('请选择开始日期和结束日期');
                    return;
                }
                
                if (new Date(startDate) > new Date(endDate)) {
                    alert('开始日期不能晚于结束日期');
                    return;
                }
                
                // 显示加载状态
                container.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> 加载中...</div>';
                
                // 禁用查询按钮
                if (queryBtn) {
                    queryBtn.disabled = true;
                    queryBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 查询中...';
                }
                
                try {
                    console.log('请求参数:', { timeUnit, startDate, endDate });
                    console.log('请求URL:', window.APP.apiBase + '/api/login/statistic?timeUnit=' + timeUnit + '&startDate=' + startDate + '&endDate=' + endDate);
                    
                    const response = await window.API.getLoginTrend(timeUnit, startDate, endDate);
                    
                    console.log('========================================');
                    console.log('✅ 登录趋势统计接口调用成功！');
                    console.log('========================================');
                    console.log('响应数据:', response);
                    
                    // 渲染数据到页面
                    renderLoginTrend(response);
                    
                    console.log('========================================');
                    console.log('登录趋势统计数据查询完成');
                    console.log('========================================');
                    
                } catch (error) {
                    console.log('========================================');
                    console.log('❌ 登录趋势统计接口调用失败！');
                    console.log('========================================');
                    console.error('错误信息:', error.message);
                    console.error('错误详情:', error);
                    console.log('========================================');
                    console.log('可能的原因:');
                    console.log('1. 后端服务未启动或端口不正确');
                    console.log('2. 接口路径不正确');
                    console.log('3. 认证token无效或已过期');
                    console.log('4. 网络连接问题');
                    console.log('========================================');
                    
                    // 显示错误信息
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>查询失败: ${error.message}</p>
                        </div>
                    `;
                } finally {
                    // 恢复查询按钮
                    if (queryBtn) {
                        queryBtn.disabled = false;
                        queryBtn.innerHTML = '<i class="fas fa-search"></i> 查询';
                    }
                }
            }
        
        // 渲染登录趋势统计
        function renderLoginTrend(data) {
            const container = document.getElementById('loginTrendContainer');
            
            if (!data || !data.points || data.points.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-chart-line"></i>
                        <p>暂无登录趋势数据</p>
                    </div>
                `;
                return;
            }
            
            // 渲染数据点
            let html = `
                <div class="trend-points">
            `;
            
            // 渲染每个时间点的数据
            data.points.forEach((point, index) => {
                html += `
                    <div class="trend-point-card">
                        <div class="trend-point-header">
                            <div class="trend-point-title">${point.timeBucket}</div>
                            <div class="trend-point-icon"><i class="fas fa-calendar-alt"></i></div>
                        </div>
                        <div class="trend-point-stats">
                            <div class="trend-stat-item">
                                <div class="trend-stat-value">${point.loginCount || 0}</div>
                                <div class="trend-stat-label">登录次数</div>
                            </div>
                            <div class="trend-stat-item">
                                <div class="trend-stat-value">${point.uniqueUsers || 0}</div>
                                <div class="trend-stat-label">活跃用户</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            container.innerHTML = html;
        }
        
        // 加载所有数据
        async function loadAllData() {
            try {
                console.log('开始加载所有数据...');
                
                // 并行加载所有数据
                const [tasksData, logsData, usersData] = await Promise.all([
                    loadAllTasks(),
                    loadAllLogs(),
                    loadAllUsers()
                ]);
                
                allTasks = tasksData;
                allLogs = logsData;
                allUsers = usersData;
                
                console.log('数据加载完成:', {
                    tasks: allTasks.length,
                    logs: allLogs.length,
                    users: allUsers.length
                });
                
                // 构建日历数据
                buildCalendarData();
                
            } catch (error) {
                console.error('加载数据失败:', error);
            }
        }
        
        // 加载所有任务（分页循环获取）
        async function loadAllTasks() {
            const tasks = [];
            let page = 1;
            const pageSize = 10000;
            
            try {
                while (true) {
                    console.log(`加载任务第${page}页...`);
                    const response = await window.API.listTasks({ page, pageSize });
                    
                    if (!response || !response.list || response.list.length === 0) {
                        break;
                    }
                    
                    tasks.push(...response.list);
                    
                    // 如果当前页数据少于pageSize，说明是最后一页
                    if (response.list.length < pageSize) {
                        break;
                    }
                    
                    page++;
                    
                    // 防止无限循环
                    if (page > 100) {
                        console.warn('⚠任务页数超过100，停止加载');
                        break;
                    }
                }
            } catch (error) {
                console.error('加载任务失败:', error);
            }
            
            return tasks;
        }
        
        // 加载所有日志
        async function loadAllLogs() {
            try {
                console.log('加载所有日志...');
                const response = await window.API.getJournals({});
                return response && response.list ? response.list : [];
            } catch (error) {
                console.error('加载日志失败:', error);
                return [];
            }
        }
        
        // 加载所有用户
        async function loadAllUsers() {
            try {
                console.log('加载所有用户...');
                // 直接使用API获取用户列表，根据任务描述，返回格式已经是用户数组
                const response = await window.API.listUsers({});
                return response || [];
            } catch (error) {
                console.error('加载用户失败:', error);
                return [];
            }
        }
        
        // 构建日历数据
        function buildCalendarData() {
            calendarData = {};
            
            // 处理任务
            allTasks.forEach(task => {
                if (task.dueAt || task.due_at) {
                    const dateStr = formatDateKey(task.dueAt || task.due_at);
                    if (!calendarData[dateStr]) {
                        calendarData[dateStr] = { tasks: [], logs: [] };
                    }
                    calendarData[dateStr].tasks.push(task);
                }
            });
            
            // 处理日志
            allLogs.forEach(log => {
                if (log.log_date || log.date) {
                    const dateStr = formatDateKey(log.log_date || log.date);
                    if (!calendarData[dateStr]) {
                        calendarData[dateStr] = { tasks: [], logs: [] };
                    }
                    calendarData[dateStr].logs.push(log);
                }
            });
            
            console.log('日历数据构建完成:', Object.keys(calendarData).length, '天有数据');
        }
        
        // 格式化日期为 YYYY-MM-DD
        function formatDateKey(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return '';
            return date.toISOString().split('T')[0];
        }
        
        // 渲染日历
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // 更新标题
            document.getElementById('calendarTitle').textContent = `${year}年${month + 1}月`;
            
            // 获取月份第一天和最后一天
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const firstDayOfWeek = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            // 获取上个月的天数
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            const today = new Date();
            const isCurrentMonth = today.getFullYear() === year && today.getMonth() === month;
            const todayDate = today.getDate();
            
            // 填充上个月的日期
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonthLastDay - i;
                const cell = document.createElement('div');
                cell.className = 'day-cell other-month';
                cell.innerHTML = `<div class="day-number">${day}</div>`;
                grid.appendChild(cell);
            }
            
            // 填充当前月的日期
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                cell.className = 'day-cell';
                if (isCurrentMonth && day === todayDate) {
                    cell.classList.add('today');
                }
                
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayData = calendarData[dateStr] || { tasks: [], logs: [] };
                
                let indicators = '';
                if (dayData.tasks.length > 0) {
                    indicators += '<div class="indicator task" title="有任务"></div>'.repeat(Math.min(dayData.tasks.length, 3));
                }
                if (dayData.logs.length > 0) {
                    indicators += '<div class="indicator log" title="有日志"></div>'.repeat(Math.min(dayData.logs.length, 3));
                }
                
                cell.innerHTML = `
                    <div class="day-number">${day}</div>
                    <div class="day-indicators">${indicators}</div>
                `;
                
                cell.onclick = () => showDayDetails(dateStr, dayData);
                grid.appendChild(cell);
            }
            
            // 填充下个月的日期
            const remainingCells = 42 - (firstDayOfWeek + daysInMonth);
            for (let day = 1; day <= remainingCells; day++) {
                const cell = document.createElement('div');
                cell.className = 'day-cell other-month';
                cell.innerHTML = `<div class="day-number">${day}</div>`;
                grid.appendChild(cell);
            }
        }
        
        // 显示某天的详情（使用精美模态框）
        async function showDayDetails(dateStr, dayData) {
            const modal = document.getElementById('dayModal');
            const modalBody = document.getElementById('modalBody');
            const modalTitle = document.getElementById('modalDateTitle');
            
            // 显示模态框
            modal.style.display = 'block';
            modalTitle.textContent = dateStr;
            
            // 显示加载状态
            modalBody.innerHTML = `
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>加载中...</p>
                </div>
            `;
            
            try {
                // 加载完整的任务详情
                const tasksWithDetails = await Promise.all(
                    dayData.tasks.map(async task => {
                        try {
                            const detail = await window.API.getTask(task.id);
                            return detail || task;
                        } catch (err) {
                            console.warn(`任务${task.id}详情加载失败:`, err);
                            return task;
                        }
                    })
                );
                
                // 渲染详情
                let content = '';
                
                // 任务部分
                if (tasksWithDetails.length > 0) {
                    content += `
                        <div class="day-section">
                            <div class="day-section-title">
                                <i class="fas fa-tasks"></i>
                                任务列表 (${tasksWithDetails.length})
                            </div>
                            ${tasksWithDetails.map(task => renderTaskDetail(task)).join('')}
                        </div>
                    `;
                }
                
                // 日志部分
                if (dayData.logs.length > 0) {
                    content += `
                        <div class="day-section">
                            <div class="day-section-title">
                                <i class="fas fa-book"></i>
                                日志记录 (${dayData.logs.length})
                            </div>
                            ${dayData.logs.map(log => renderLogDetail(log)).join('')}
                        </div>
                    `;
                }
                
                // 空状态
                if (tasksWithDetails.length === 0 && dayData.logs.length === 0) {
                    content = `
                        <div class="empty-state">
                            <i class="fas fa-calendar-times"></i>
                            <p>这一天没有任务或日志</p>
                        </div>
                    `;
                }
                
                modalBody.innerHTML = content;
                
            } catch (error) {
                console.error('加载详情失败:', error);
                modalBody.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>加载失败，请稍后重试</p>
                    </div>
                `;
            }
        }
        
        // 渲染任务详情卡片
        function renderTaskDetail(task) {
            const priorityMap = { 'high': '高', 'medium': '中', 'low': '低' };
            const statusMap = { 'pending': '待处理', 'in_progress': '进行中', 'completed': '已完成', 'cancelled': '已取消' };
            const priority = priorityMap[task.priority] || '未设置';
            const status = statusMap[task.status] || '未知';
            const progress = task.progress || 0;
            
            return `
                <div class="detail-card">
                    <div class="detail-card-header">
                        <div class="detail-title">${task.title || task.name || '未命名任务'}</div>
                        <div class="detail-badges">
                            <span class="badge priority-${task.priority || 'low'}">${priority}</span>
                            <span class="badge status">${status}</span>
                        </div>
                    </div>
                    
                    <div class="detail-info">
                        ${task.assignee_name ? `
                            <div class="info-item">
                                <i class="fas fa-user"></i>
                                <span>负责人: ${task.assignee_name}</span>
                            </div>
                        ` : ''}
                        ${task.dueAt || task.due_at ? `
                            <div class="info-item">
                                <i class="fas fa-calendar-alt"></i>
                                <span>截止: ${formatDate(task.dueAt || task.due_at)}</span>
                            </div>
                        ` : ''}
                        ${task.createdAt || task.created_at ? `
                            <div class="info-item">
                                <i class="fas fa-clock"></i>
                                <span>创建: ${formatDate(task.createdAt || task.created_at)}</span>
                            </div>
                        ` : ''}
                        ${task.updatedAt || task.updated_at ? `
                            <div class="info-item">
                                <i class="fas fa-edit"></i>
                                <span>更新: ${formatDate(task.updatedAt || task.updated_at)}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${task.description ? `
                        <div class="detail-description">
                            <strong>描述:</strong> ${task.description}
                        </div>
                    ` : ''}
                    
                    <div class="progress-section">
                        <div class="progress-label">进度: ${progress}%</div>
                        <div class="progress-bar-wrapper">
                            <div class="progress-bar-inner" style="width: ${progress}%"></div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // 渲染日志详情卡片
        function renderLogDetail(log) {
            return `
                <div class="log-card">
                    <div class="log-title">${log.title || '未命名日志'}</div>
                    <div class="log-meta">
                        ${log.authorName ? `<span><i class="fas fa-user"></i> ${log.authorName}</span> ` : ''}
                        ${log.createdAt || log.created_at ? `<span><i class="fas fa-clock"></i> ${formatDate(log.createdAt || log.created_at)}</span>` : ''}
                    </div>
                    ${log.content ? `<div style="margin-top: 8px; color: #558b2f;">${log.content}</div>` : ''}
                </div>
            `;
        }
        
        // 关闭模态框
        function closeDayModal() {
            document.getElementById('dayModal').style.display = 'none';
        }
        
        // 点击模态框外部关闭
        window.onclick = function(event) {
            const dayModal = document.getElementById('dayModal');
            const editModal = document.getElementById('editImportantTasksModal');
            
            if (event.target === dayModal) {
                closeDayModal();
            }
            
            if (event.target === editModal) {
                closeEditImportantTasksModal();
            }
        }
        
        // 格式化日期
        function formatDate(dateStr) {
            if (!dateStr) return '未知';
            const date = new Date(dateStr);
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            const h = String(date.getHours()).padStart(2, '0');
            const min = String(date.getMinutes()).padStart(2, '0');
            return `${y}-${m}-${d} ${h}:${min}`;
        }
        
        // 上一个月
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }
        
        // 下一个月
        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }
        
        // 渲染统计数据
        function renderStats() {
            // 任务统计
            const totalTasks = allTasks.length;
            const completedTasks = allTasks.filter(t => (t.progress || 0) >= 100).length;
            const inProgressTasks = allTasks.filter(t => {
                const p = t.progress || 0;
                return p > 0 && p < 100;
            }).length;
            const pendingTasks = allTasks.filter(t => (t.progress || 0) === 0).length;
            
            document.getElementById('totalTasks').textContent = totalTasks;
            document.getElementById('completedTasks').textContent = completedTasks;
            document.getElementById('inProgressTasks').textContent = inProgressTasks;
            document.getElementById('pendingTasks').textContent = pendingTasks;
            document.getElementById('totalLogs').textContent = allLogs.length;
            document.getElementById('totalUsers').textContent = allUsers.length;
        }
        
        // 加载用户统计数据
        async function loadUserStats() {
            try {
                console.log('加载用户统计数据...');
                
                // 如果用户数据还没有加载，先加载用户数据
                if (!allUsers || allUsers.length === 0) {
                    await loadAllUsers();
                }
                
                // 计算用户统计数据
                const activeUsers = allUsers.filter(u => u.status === 'active').length;
                const inactiveUsers = allUsers.filter(u => u.status !== 'active').length;
                
                // 按角色统计
                const adminUsers = allUsers.filter(u => u.role_id == 5).length;
                const managerUsers = allUsers.filter(u => u.role_id == 2).length;
                const teamLeaderUsers = allUsers.filter(u => u.role_id == 3).length;
                const memberUsers = allUsers.filter(u => u.role_id == 4).length;
                const ceoUsers = allUsers.filter(u => u.role_id == 1).length;
                
                // 更新统计数据
                document.getElementById('activeUsers').textContent = activeUsers;
                document.getElementById('inactiveUsers').textContent = inactiveUsers;
                document.getElementById('adminUsers').textContent = adminUsers;
                document.getElementById('managerUsers').textContent = managerUsers;
                document.getElementById('teamLeaderUsers').textContent = teamLeaderUsers;
                document.getElementById('memberUsers').textContent = memberUsers;
                
                console.log('用户统计数据加载完成:', {
                    total: allUsers.length,
                    active: activeUsers,
                    inactive: inactiveUsers,
                    admin: adminUsers,
                    manager: managerUsers,
                    teamLeader: teamLeaderUsers,
                    member: memberUsers,
                    ceo: ceoUsers
                });
                
            } catch (error) {
                console.error('加载用户统计数据失败:', error);
            }
        }
        
        
        // 渲染今日概览
        function renderTodaySummary() {
            const today = new Date().toISOString().split('T')[0];
            const todayData = calendarData[today] || { tasks: [], logs: [] };
            
            document.getElementById('todayTasks').textContent = todayData.tasks.length;
            document.getElementById('todayLogs').textContent = todayData.logs.length;
            
            // 计算即将到期的任务（7天内）
            const upcoming = allTasks.filter(task => {
                const dueDate = task.dueAt || task.due_at;
                if (!dueDate) return false;
                const due = new Date(dueDate);
                const now = new Date();
                const diff = (due - now) / (1000 * 60 * 60 * 24);
                return diff >= 0 && diff <= 7;
            }).length;
            
            document.getElementById('upcomingDeadlines').textContent = upcoming;
        }
        
        // 渲染近期任务
        function renderRecentTasks() {
            const container = document.getElementById('recentTasksList');
            
            if (allTasks.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #7a5a33; padding: 20px;">暂无任务</div>';
                return;
            }
            
            // 按更新时间排序，取最近5个
            const recentTasks = [...allTasks]
                .sort((a, b) => {
                    const dateA = new Date(a.updatedAt || a.updated_at || a.createdAt || a.created_at || 0);
                    const dateB = new Date(b.updatedAt || b.updated_at || b.createdAt || b.created_at || 0);
                    return dateB - dateA;
                })
                .slice(0, 5);
            
            container.innerHTML = recentTasks.map(task => {
                const priority = task.priority || 'low';
                const priorityText = { high: '高', medium: '中', low: '低' }[priority] || '低';
                const progress = task.progress || 0;
                
                return `
                <div class="task-item">
                        <div class="task-header">
                            <div class="task-title">${task.title || task.name || '未命名任务'}</div>
                            <div class="task-priority ${priority}">${priorityText}</div>
                        </div>
                        <div class="task-meta">
                            进度: ${progress}%
                            ${task.dueAt || task.due_at ? ` | 截止: ${formatDate(task.dueAt || task.due_at)}` : ''}
                        </div>
                        <div class="task-progress-bar">
                            <div class="task-progress-fill" style="width: ${progress}%"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // 格式化日期显示
        function formatDate(dateStr) {
            if (!dateStr) return '未设定';
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return '未设定';
            return `${date.getMonth() + 1}月${date.getDate()}日`;
        }
        
        // 初始化图表
        function initCharts() {
            // 用户角色分布饼图
            const userRoleCtx = document.getElementById('userRoleChart').getContext('2d');
            userRoleChart = new Chart(userRoleCtx, {
                type: 'doughnut',
                data: {
                    labels: ['CEO', 'Manager', 'Team Leader', 'Member', 'Admin'],
                    datasets: [{
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: ['#F44336', '#FF9800', '#2196F3', '#4CAF50', '#9C27B0'],
                        borderColor: ['#fff', '#fff', '#fff', '#fff', '#fff'],
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 13 }
                            }
                        }
                    }
                }
            });

            // 用户性别分布饼图
            const userGenderCtx = document.getElementById('userGenderChart').getContext('2d');
            userGenderChart = new Chart(userGenderCtx, {
                type: 'doughnut',
                data: {
                    labels: ['男性', '女性', '未知'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#2196F3', '#E91E63', '#9E9E9E'],
                        borderColor: ['#fff', '#fff', '#fff'],
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 13 }
                            }
                        }
                    }
                }
            });

            // 用户状态分布饼图
            const userStatusCtx = document.getElementById('userStatusChart').getContext('2d');
            userStatusChart = new Chart(userStatusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['活跃', '非活跃'],
                    datasets: [{
                        data: [0, 0],
                        backgroundColor: ['#4CAF50', '#F44336'],
                        borderColor: ['#fff', '#fff'],
                        borderWidth: 3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 15,
                                font: { size: 13 }
                            }
                        }
                    }
                }
            });
        }

        // 更新图表数据
        function updateCharts() {
            // 更新用户角色分布饼图
            const ceoUsers = allUsers.filter(u => u.role_id == 1).length;
            const managerUsers = allUsers.filter(u => u.role_id == 2).length;
            const teamLeaderUsers = allUsers.filter(u => u.role_id == 3).length;
            const memberUsers = allUsers.filter(u => u.role_id == 4).length;
            const adminUsers = allUsers.filter(u => u.role_id == 5).length;
            
            userRoleChart.data.datasets[0].data = [ceoUsers, managerUsers, teamLeaderUsers, memberUsers, adminUsers];
            userRoleChart.update();

            // 更新用户性别分布饼图
            const maleUsers = allUsers.filter(u => u.gender === 'M' || u.gender === 'Male' || u.gender === '男').length;
            const femaleUsers = allUsers.filter(u => u.gender === 'F' || u.gender === 'Female' || u.gender === '女').length;
            const unknownGenderUsers = allUsers.length - maleUsers - femaleUsers;
            
            userGenderChart.data.datasets[0].data = [maleUsers, femaleUsers, unknownGenderUsers];
            userGenderChart.update();
            
            // 更新用户状态分布饼图
            const activeUsers = allUsers.filter(u => u.status === 'active').length;
            const inactiveUsers = allUsers.filter(u => u.status !== 'active').length;
            
            userStatusChart.data.datasets[0].data = [activeUsers, inactiveUsers];
            userStatusChart.update();
        }
        
        // 加载公司重要事项
        async function loadImportantTasks() {
            try {
                const tasks = await window.API.getImportantTasks();
                const container = document.getElementById('importantTasksList');
                
                if (!tasks || tasks.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #7a5a33; padding: 20px;">暂无重要事项</div>';
                    return;
                }
                
                container.innerHTML = tasks.map(task => `
                    <div class="important-item">
                        <i class="fas fa-check-circle"></i>
                        <span>${task}</span>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('加载公司重要事项失败:', error);
                document.getElementById('importantTasksList').innerHTML = 
                    '<div style="text-align: center; color: #999; padding: 20px;">加载失败</div>';
            }
        }
        
        // 打开编辑公司重要事项模态框
        async function openEditImportantTasksModal() {
            try {
                // 获取当前的重要事项
                const currentTasks = await window.API.getImportantTasks();
                const modal = document.getElementById('editImportantTasksModal');
                const container = document.getElementById('editTasksContainer');
                
                // 确保有10个事项，不足则补充空字符串
                const tasks = [];
                for (let i = 0; i < 10; i++) {
                    tasks.push(currentTasks[i] || '');
                }
                
                // 生成编辑表单
                container.innerHTML = tasks.map((task, index) => `
                    <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 16px; padding: 16px; background: #fff; border-radius: 12px; border: 1px solid #ffd3a1; box-shadow: 0 2px 6px rgba(255,138,0,0.05); transition: all 0.3s;"
                         onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(255,138,0,0.15)'"
                         onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(255,138,0,0.05)'">
                        <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #ff8a00 0%, #ffbe78 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; flex-shrink: 0; box-shadow: 0 2px 6px rgba(255,138,0,0.2);">
                            ${index + 1}
                        </div>
                        <input type="text"
                               id="taskInput${index}"
                               value="${task}"
                               placeholder="请输入第${index + 1}个重要事项"
                               style="flex: 1; padding: 14px 16px; border: 2px solid #ffd3a1; border-radius: 10px; font-size: 14px; transition: all 0.3s; outline: none; background: #fff7ef;"
                               onfocus="this.style.borderColor='#ff8a00'; this.style.boxShadow='0 0 0 4px rgba(255,138,0,0.15)'; this.style.background='#fff'"
                               onblur="this.style.borderColor='#ffd3a1'; this.style.boxShadow='none'; this.style.background='#fff7ef'">
                    </div>
                `).join('');
                
                // 显示模态框
                modal.style.display = 'block';
                
            } catch (error) {
                console.error('打开编辑模态框失败:', error);
                alert('加载重要事项失败，请稍后重试');
            }
        }
        
        // 关闭编辑公司重要事项模态框
        function closeEditImportantTasksModal() {
            document.getElementById('editImportantTasksModal').style.display = 'none';
        }
        
        // 保存公司重要事项
        async function saveImportantTasks() {
            try {
                // 收集所有输入的值
                const tasks = [];
                for (let i = 0; i < 10; i++) {
                    const input = document.getElementById(`taskInput${i}`);
                    const value = input.value.trim();
                    
                    if (!value) {
                        alert(`第${i + 1}个重要事项不能为空`);
                        input.focus();
                        return;
                    }
                    
                    tasks.push(value);
                }
                
                // 显示保存中状态
                const saveButton = event.target;
                const originalText = saveButton.innerHTML;
                saveButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';
                saveButton.disabled = true;
                
                console.log('准备发送到API的任务列表:', tasks);
                
                // 调用API保存
                const response = await window.API.updateImportantTasks(tasks);
                console.log('API响应:', response);
                
                // 恢复按钮状态
                saveButton.innerHTML = originalText;
                saveButton.disabled = false;
                
                // 检查响应是否表示成功
                if (response && !response.error) {
                    // 成功情况
                    closeEditImportantTasksModal();
                    showSuccessMessage('公司重要事项已更新');
                    
                    // 重新加载重要事项
                    setTimeout(async () => {
                        await loadImportantTasks();
                    }, 500);
                } else {
                    // 失败情况
                    const errorMsg = response && response.message ? response.message : '保存失败';
                    showErrorMessage(errorMsg);
                    
                    // 即使失败也重新加载重要事项，以防部分更新成功
                    setTimeout(async () => {
                        await loadImportantTasks();
                    }, 500);
                }
                
            } catch (error) {
                console.error('保存重要事项失败:', error);
                
                // 恢复按钮状态
                const saveButton = event.target;
                saveButton.innerHTML = '<i class="fas fa-save"></i> 保存';
                saveButton.disabled = false;
                
                // 显示更友好的错误提示
                showErrorMessage('保存失败：' + (error.message || '未知错误'));
            }
        }
        
        // 显示成功消息
        function showSuccessMessage(message) {
            // 创建成功提示元素
            const successDiv = document.createElement('div');
            successDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(76,175,80,0.3);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 8px;
                font-weight: 500;
                animation: slideInRight 0.3s ease-out;
            `;
            successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            
            // 添加动画样式
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            // 添加到页面
            document.body.appendChild(successDiv);
            
            // 3秒后自动移除
            setTimeout(() => {
                successDiv.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => {
                    document.body.removeChild(successDiv);
                }, 300);
            }, 3000);
        }
        
        // 显示错误消息
        function showErrorMessage(message) {
            // 创建错误提示元素
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #F44336 0%, #EF5350 100%);
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(244,67,54,0.3);
                z-index: 10000;
                display: flex;
                align-items: center;
                gap: 8px;
                font-weight: 500;
                animation: slideInRight 0.3s ease-out;
                max-width: 400px;
            `;
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            
            // 添加动画样式
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideInRight {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
            `;
            document.head.appendChild(style);
            
            // 添加到页面
            document.body.appendChild(errorDiv);
            
            // 5秒后自动移除
            setTimeout(() => {
                errorDiv.style.animation = 'slideInRight 0.3s ease-out reverse';
                setTimeout(() => {
                    document.body.removeChild(errorDiv);
                }, 300);
            }, 5000);
        }
    </script>
</body>
</html>
