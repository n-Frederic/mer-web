<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日程表 - 潘多拉工作日志管理系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/theme.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { align-items: flex-start; }
        .layout { width: 100%; max-width: 1320px; margin: 32px auto; padding: 0 40px; }
        .topbar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .brand { display: flex; align-items: center; gap: 12px; }
        .brand .logo { width: 48px; height: 48px; margin: 0; }
        .brand strong { font-size: 20px; font-family: 'ZCOOL KuaiLe', 'Noto Sans SC', sans-serif; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, var(--color-peach), var(--color-primary-2)); border: 2px solid #fff; box-shadow: 0 3px 10px rgba(255,138,0,0.25); }
        .panel { background: #fff; border-radius: 14px; padding: 18px; }
        .nav-links { display:flex; gap:10px; }
        .nav-links a { padding:8px 12px; border-radius:10px; background:#fff7ef; border:1px solid #ffd3a1; color:#a55b00; text-decoration:none; }
        .nav-links a:hover { background:#ffe9d2; }
        .panel h3 { margin-bottom: 12px; color: #a55b00; font-family: 'ZCOOL KuaiLe', 'Noto Sans SC', sans-serif; font-size: 22px; }
        .calendar { background: #fff; border-radius: 14px; padding: 16px; }
        .calendar .row { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 8px; }
        .calendar .cell { background: #fff7ef; border: 1px dashed #ffd3a1; min-height: 96px; border-radius: 8px; padding: 6px; font-size: 12px; color: #a55b00; }
        .calendar .today { background: #ffe8cf; border-color: #ffbe78; }
        
        /* 統計數據樣式 */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
        @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 600px) { .stats-grid { grid-template-columns: 1fr; } }
        .stat-card { background: linear-gradient(135deg, var(--color-cream) 0%, var(--color-peach) 100%); border-radius: 12px; padding: 16px; text-align: center; border: 1px solid #ffd3a1; }
        .stat-number { font-size: 28px; font-weight: 700; color: var(--color-primary); margin-bottom: 4px; }
        .stat-label { font-size: 13px; color: #7a5a33; }
        .recent-tasks { margin-top: 20px; }
        .task-item { background: #fff; border: 1px solid #ffd3a1; border-radius: 8px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .task-info { flex: 1; }
        .task-name { font-weight: 500; color: #333; margin-bottom: 2px; }
        .task-meta { font-size: 12px; color: #7a5a33; }
        .task-progress { width: 60px; text-align: right; font-size: 12px; color: var(--color-primary); font-weight: 500; }
        
        /* 圖表樣式 */
        .charts-section { margin-top: 20px; }
        .charts-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 20px; }
        @media (max-width: 900px) { .charts-grid { grid-template-columns: 1fr; } }
        .chart-container { background: #fff; border: 1px solid #ffd3a1; border-radius: 12px; padding: 16px; }
        .chart-title { color: #a55b00; font-weight: 500; margin-bottom: 12px; text-align: center; }
        .chart-canvas { position: relative; height: 250px; }
    </style>
</head>
<body>
    <div class="layout">
        <div class="topbar">
            <div class="brand">
                <div class="logo">P</div>
                <strong>日程表</strong>
            </div>
            <div style="display:flex; align-items:center; gap:16px;">
                <nav class="nav-links">
                    <a href="publish.html">发布任务</a>
                    <a href="dashboard.html">工作日志</a>
                    <a href="users.html">用户管理</a>
                    <a href="tasks.html">任务展示</a>
                    <a href="profile.html">个人信息</a>
                </nav>
                <div class="profile" onclick="location.href='profile.html'" style="display:flex;align-items:center;gap:10px;cursor:pointer;">
                <span id="currentUserName">用户</span>
                <div class="avatar"></div>
                </div>
            </div>
        </div>

        <!-- 統計數據區域 -->
        <div class="panel">
            <h3>数据统计</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalTasks">-</div>
                    <div class="stat-label">总任务数</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedTasks">-</div>
                    <div class="stat-label">已完成</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="inProgressTasks">-</div>
                    <div class="stat-label">进行中</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingTasks">-</div>
                    <div class="stat-label">待开始</div>
                </div>
            </div>
            
            <div class="recent-tasks">
                <h4 style="color: #a55b00; margin-bottom: 12px;">最近任务</h4>
                <div id="recentTasksList">
                    <div style="text-align: center; color: #7a5a33; padding: 20px;">加载中...</div>
                </div>
            </div>
            
            <!-- 圖表統計區域 -->
            <div class="charts-section">
                <h4 style="color: #a55b00; margin-bottom: 16px;">数据可视化</h4>
                <div class="charts-grid">
                    <div class="chart-container">
                        <div class="chart-title">任务完成度分布</div>
                        <div class="chart-canvas">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-container">
                        <div class="chart-title">任务进度统计</div>
                        <div class="chart-canvas">
                            <canvas id="barChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">本周任务趋势</div>
                    <div class="chart-canvas" style="height: 200px;">
                        <canvas id="lineChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <h3>本月日程（示意）</h3>
            <div class="calendar">
                <div class="row" id="calendarGrid"></div>
            </div>
        </div>
    </div>

    <script src="js/common.js"></script>
    <script src="js/api.js"></script>
    <script>
        // 设置用户名
        try { const raw=localStorage.getItem('currentUser'); const u=raw?JSON.parse(raw):{name:'用户'}; document.getElementById('currentUserName').textContent=u.name||'用户'; } catch(e){}
        
        // 日程表渲染
        const grid=document.getElementById('calendarGrid');
        const today=new Date().getDate();
        const cells=Array.from({length:35}).map((_,i)=>{ const day=i+1; const isToday=day===today; return `<div class="cell ${isToday?'today':''}">${day<=30?day:''}</div>`; }).join('');
        grid.innerHTML=cells;

        // 載入統計數據
        async function loadStats() {
            try {
                // 嘗試從後端獲取統計數據
                if (window.API && typeof window.API.getStats === 'function') {
                    const stats = await window.API.getStats();
                    updateStatsDisplay(stats);
                    return;
                }
                
                // 回退方案：從任務列表計算統計
                const tasksResp = window.API && typeof window.API.listTasks === 'function' 
                    ? await window.API.listTasks() 
                    : { list: [] };
                
                const tasks = tasksResp.list || [];
                const stats = calculateStats(tasks);
                updateStatsDisplay(stats);
                updateRecentTasks(tasks.slice(0, 5));
                updateCharts(stats, tasks);
                
            } catch (error) {
                console.error('载入统计数据失败:', error);
                document.getElementById('recentTasksList').innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">載入失敗</div>';
            }
        }

        // 計算統計數據
        function calculateStats(tasks) {
            const total = tasks.length;
            const completed = tasks.filter(t => t.progress >= 100).length;
            const inProgress = tasks.filter(t => t.progress > 0 && t.progress < 100).length;
            const pending = tasks.filter(t => t.progress === 0).length;
            
            return {
                totalTasks: total,
                completedTasks: completed,
                inProgressTasks: inProgress,
                pendingTasks: pending
            };
        }

        // 更新統計顯示
        function updateStatsDisplay(stats) {
            document.getElementById('totalTasks').textContent = stats.totalTasks || 0;
            document.getElementById('completedTasks').textContent = stats.completedTasks || 0;
            document.getElementById('inProgressTasks').textContent = stats.inProgressTasks || 0;
            document.getElementById('pendingTasks').textContent = stats.pendingTasks || 0;
        }

        // 更新最近任務
        function updateRecentTasks(tasks) {
            const container = document.getElementById('recentTasksList');
            
            if (!tasks || tasks.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #7a5a33; padding: 20px;">暂无任务</div>';
                return;
            }
            
            container.innerHTML = tasks.map(task => `
                <div class="task-item">
                    <div class="task-info">
                        <div class="task-name">${task.name || '未命名任务'}</div>
                        <div class="task-meta">負責人: ${task.owner || '未指定'} | 截止: ${task.endDate || '未设定'}</div>
                    </div>
                    <div class="task-progress">${task.progress || 0}%</div>
                </div>
            `).join('');
        }

        // 圖表實例
        let pieChart, barChart, lineChart;

        // 初始化圖表
        function initCharts() {
            // 餅圖 - 任務完成度分佈
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            pieChart = new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: ['已完成', '进行中', '待开始'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#4CAF50', '#FF9800', '#F44336'],
                        borderColor: ['#45a049', '#e68900', '#da190b'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });

            // 條形圖 - 任務進度統計
            const barCtx = document.getElementById('barChart').getContext('2d');
            barChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: ['0-25%', '26-50%', '51-75%', '76-99%', '100%'],
                    datasets: [{
                        label: '任务数量',
                        data: [0, 0, 0, 0, 0],
                        backgroundColor: ['#FF6B6B', '#FFA726', '#FFEB3B', '#66BB6A', '#4CAF50'],
                        borderColor: ['#E53935', '#FF9800', '#FBC02D', '#4CAF50', '#2E7D32'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });

            // 折線圖 - 本週任務趨勢
            const lineCtx = document.getElementById('lineChart').getContext('2d');
            const weekDays = ['周一', '周二', '周三', '周四', '周五', '周六', '周日'];
            lineChart = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: weekDays,
                    datasets: [{
                        label: '新建任务',
                        data: [2, 3, 1, 4, 2, 1, 0],
                        borderColor: '#FF8A00',
                        backgroundColor: 'rgba(255, 138, 0, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: '完成任务',
                        data: [1, 2, 2, 3, 1, 2, 1],
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // 更新圖表數據
        function updateCharts(stats, tasks) {
            // 更新餅圖
            pieChart.data.datasets[0].data = [
                stats.completedTasks || 0,
                stats.inProgressTasks || 0,
                stats.pendingTasks || 0
            ];
            pieChart.update();

            // 更新條形圖 - 按進度分組
            const progressGroups = [0, 0, 0, 0, 0]; // 0-25%, 26-50%, 51-75%, 76-99%, 100%
            if (tasks && tasks.length > 0) {
                tasks.forEach(task => {
                    const progress = task.progress || 0;
                    if (progress === 100) progressGroups[4]++;
                    else if (progress >= 76) progressGroups[3]++;
                    else if (progress >= 51) progressGroups[2]++;
                    else if (progress >= 26) progressGroups[1]++;
                    else progressGroups[0]++;
                });
            }
            barChart.data.datasets[0].data = progressGroups;
            barChart.update();

            // 折線圖使用模擬數據（實際項目中可以從後端獲取）
            // 這裡可以根據任務的創建日期和完成日期來生成真實數據
        }

        // 頁面載入時執行
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            loadStats();
        });
    </script>
</body>
</html>

